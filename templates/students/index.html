{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تسيير متوسطة بوشنافة عمر - النسخة النهائية المستقرة</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="{% static 'js/xlsx.full.min.js' %}"></script>
    <style>
        /* Styles are now in static/css/styles.css, but keeping critical overrides if any */
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <h1><i class="fas fa-graduation-cap"></i> تسيير تلاميذ متوسطة بوشنافة عمر</h1>
        <span id="modeStatus"><i class="fas fa-eye"></i> وضع العرض</span>
    </div>

    <div class="app-content">
        <div class="sidebar-photo">
            <div class="photo-card" id="photoFrame">
                <i class="fas fa-user fa-3x" id="placeholderIcon" style="color:#e2e8f0"></i>
                <img id="displayImage">
            </div>
            <input type="file" id="imageSelector" style="display:none" accept="image/*" onchange="handleImageSelection(this)">
            <button class="btn" id="photoBtn" style="color:#333; background:#e2e8f0; width:100%; margin-top:10px;" onclick="triggerImageSelect()">
                <i class="fas fa-camera"></i> صورة التلميذ
            </button>
            <button class="btn" id="deletePhotoBtn" style="color:#fff; background:var(--danger); width:100%; margin-top:5px; display:none;" onclick="removePhotoImage()">
                <i class="fas fa-trash-alt"></i> حذف الصورة
            </button>
        </div>

        <div class="main-form" id="studentForm">
            <!-- Hidden field to store ID for editing -->
            <input type="hidden" id="dbId">

            <div class="field-box"><label>اللقب *</label><input type="text" id="lastName" class="form-input"></div>
            <div class="field-box"><label>الاسم *</label><input type="text" id="firstName" class="form-input"></div>
            <div class="field-box"><label>رقم التعريف الوطني (16 رقم) *</label><input type="text" id="studentID" maxlength="16" class="form-input"></div>
            <div class="field-box"><label>تاريخ الازدياد *</label><input type="text" id="dateOfBirth" class="date-input form-input" placeholder="يوم / شهر / سنة"></div>
            <div class="field-box"><label>مكان الميلاد *</label><input type="text" id="placeOfBirth" class="form-input"></div>
            <div class="field-box"><label>الجنس *</label>
                <select id="gender" class="form-input">
                    <option value="">اختر...</option><option value="ذكر">ذكر</option><option value="أنثى">أنثى</option>
                </select>
            </div>
            <div class="field-box"><label>المستوى *</label>
                <select id="academicYear" class="form-input">
                    <option value="">اختر...</option><option value="أولى">أولى</option><option value="ثانية">ثانية</option><option value="ثالثة">ثالثة</option><option value="رابعة">رابعة</option>
                </select>
            </div>
            <div class="field-box"><label>القسم (رقمين) *</label><input type="text" id="className" class="form-input" maxlength="2"></div>
            <div class="field-box"><label>نظام التمدرس *</label><select id="attendanceSystem" class="form-input"><option value="خارجي">خارجي</option><option value="نصف داخلي">نصف داخلي</option></select></div>
            <div class="field-box"><label>رقم القيد (4 أرقام)</label><input type="text" id="enrollmentNumber" class="form-input" maxlength="4"></div>
            <div class="field-box"><label>تاريخ التسجيل *</label><input type="text" id="enrollmentDate" class="date-input form-input" placeholder="يوم / شهر / سنة"></div>
            <div class="field-box"><label>تاريخ الخروج</label><input type="text" id="exitDate" class="date-input form-input" placeholder="يوم / شهر / سنة"></div>
            <div class="field-box span-2"><label>اسم الولي الكامل *</label><input type="text" id="guardianName" class="form-input"></div>
            <div class="field-box span-2"><label>لقب واسم الأم *</label><input type="text" id="motherName" class="form-input"></div>
            <div class="field-box span-2"><label>رقم هاتف الولي (10 أرقام) *</label><input type="text" id="guardianPhone" class="form-input" maxlength="10"></div>
            <div class="field-box span-2"><label>عنوان السكن *</label><input type="text" id="address" class="form-input"></div>
            <input type="hidden" id="photoPath">
        </div>
    </div>

    <div class="action-tray">
        <button class="btn" style="background:var(--success)" onclick="prepareNew()"><i class="fas fa-plus"></i> جديد</button>
        <button class="btn" style="background:var(--primary)" onclick="saveCurrent()"><i class="fas fa-save"></i> حفظ</button>
        <button class="btn" style="background:var(--warning)" onclick="enableEditing()"><i class="fas fa-edit"></i> تعديل</button>
        <button class="btn" style="background:var(--danger)" onclick="deleteStudent()"><i class="fas fa-trash"></i> حذف</button>
        <button class="btn" style="background:#0891b2" onclick="importExcel()"><i class="fas fa-file-excel"></i> استيراد إكسل</button>
        <button class="btn" style="background:var(--success)" onclick="bulkSave()"><i class="fas fa-file-import"></i> حفظ الكل (تزامن)</button>
        <button class="btn" style="background:var(--secondary)" onclick="window.print()"><i class="fas fa-print"></i> طباعة</button>
        <button class="btn" style="background:#334155" onclick="exportBackup()"><i class="fas fa-database"></i> نسخة احتياطية</button>
    </div>

    <div class="table-wrapper">
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>رقم التعريف</th><th>اللقب</th><th>الاسم</th><th>تاريخ الازدياد</th><th>المستوى</th><th>القسم</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
let studentsList = []; // Used for local display of imported data or fetched data
let isEditMode = false;
const API_URL = '/api/students/';

// Date Helper Functions
function toDjangoDate(dateStr) {
    // Converts DD / MM / YYYY to YYYY-MM-DD
    if (!dateStr) return null;
    const parts = dateStr.split(' / ');
    if (parts.length !== 3) return null;
    return `${parts[2]}-${parts[1]}-${parts[0]}`;
}

function fromDjangoDate(dateStr) {
    // Converts YYYY-MM-DD to DD / MM / YYYY
    if (!dateStr) return "";
    const date = new Date(dateStr);
    return `${String(date.getDate()).padStart(2, '0')} / ${String(date.getMonth() + 1).padStart(2, '0')} / ${date.getFullYear()}`;
}

function formatStrictDate(val) {
    if (!val) return "";
    let date;
    if (typeof val === 'number') date = new Date(Math.round((val - 25569) * 864e5));
    else date = new Date(val);
    if (isNaN(date.getTime())) return val;
    return `${String(date.getDate()).padStart(2, '0')} / ${String(date.getMonth() + 1).padStart(2, '0')} / ${date.getFullYear()}`;
}

// Fetch Data on Load
document.addEventListener('DOMContentLoaded', fetchStudents);

async function fetchStudents() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        studentsList = data; // Store fetched data
        renderTable();
    } catch (err) {
        console.error("Error fetching students:", err);
        alert("تعذر تحميل البيانات من الخادم.");
    }
}

function renderTable() {
    const tbody = document.querySelector('#studentsTable tbody');
    tbody.innerHTML = studentsList.map((s, i) => `
        <tr onclick="fillForm(${i}, this)">
            <td>${s.student_id_number || s.id}</td>
            <td>${s.last_name || s.ln}</td>
            <td>${s.first_name || s.fn}</td>
            <td>${s.date_of_birth ? fromDjangoDate(s.date_of_birth) : (s.dob || "")}</td>
            <td>${s.academic_year || s.level}</td>
            <td>${s.class_name || s.class}</td>
        </tr>
    `).join('');
}

function fillForm(idx, row) {
    const s = studentsList[idx];
    document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row')); row.classList.add('selected-row');

    // Map backend fields to frontend inputs
    document.getElementById('dbId').value = s.id || ""; // ID from Django
    document.getElementById('lastName').value = s.last_name || s.ln || "";
    document.getElementById('firstName').value = s.first_name || s.fn || "";
    document.getElementById('studentID').value = s.student_id_number || s.id || ""; // student_id_number is 'id' in local import
    document.getElementById('dateOfBirth').value = s.date_of_birth ? fromDjangoDate(s.date_of_birth) : (s.dob || "");
    document.getElementById('placeOfBirth').value = s.place_of_birth || s.pob || "";
    document.getElementById('gender').value = s.gender || "";
    document.getElementById('academicYear').value = s.academic_year || s.level || "";
    document.getElementById('className').value = s.class_name || s.class || "";
    document.getElementById('attendanceSystem').value = s.attendance_system || s.sys || "";
    document.getElementById('guardianName').value = s.guardian_name || s.guard || "";
    document.getElementById('motherName').value = s.mother_name || s.mother || "";
    document.getElementById('guardianPhone').value = s.guardian_phone || s.phone || "";
    document.getElementById('address').value = s.address || s.addr || "";
    document.getElementById('enrollmentNumber').value = s.enrollment_number || s.enrollNum || "";
    document.getElementById('enrollmentDate').value = s.enrollment_date ? fromDjangoDate(s.enrollment_date) : (s.enrollDate || "");
    document.getElementById('exitDate').value = s.exit_date ? fromDjangoDate(s.exit_date) : (s.exitDate || "");
    document.getElementById('photoPath').value = s.photo_path || s.photo || "";

    updatePhotoUI(s.photo_path || s.photo);
    lockFields(true);
    document.getElementById('modeStatus').innerHTML = '<i class="fas fa-eye"></i> وضع العرض';
    isEditMode = false;
}

// ... Keep helper functions like applyMask, lockFields, updatePhotoUI ...
function applyMask(id) {
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g, '').substr(0, 8);
        let f = "";
        if (v.length > 0) {
            f += v.substr(0, 2);
            if (v.length > 2) f += ' / ' + v.substr(2, 2);
            if (v.length > 4) f += ' / ' + v.substr(4, 4);
        }
        e.target.value = f;
    });
}
['dateOfBirth', 'enrollmentDate', 'exitDate'].forEach(applyMask);

function lockFields(lock) {
    document.querySelectorAll('.form-input').forEach(input => {
        input.disabled = lock;
        input.classList.toggle('disabled-field', lock);
    });
    document.getElementById('photoBtn').disabled = lock;
    document.getElementById('photoBtn').style.opacity = lock ? "0.5" : "1";
    document.getElementById('deletePhotoBtn').style.display = (!lock && isEditMode) ? "flex" : "none";
}
lockFields(true);

function triggerImageSelect() { document.getElementById('imageSelector').click(); }
function handleImageSelection(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('photoPath').value = e.target.result;
            updatePhotoUI(e.target.result);
        };
        reader.readAsDataURL(input.files[0]);
    }
}
function removePhotoImage() { if(confirm("إزالة الصورة؟")) { document.getElementById('photoPath').value = ""; updatePhotoUI(""); } }

function updatePhotoUI(data) {
    const img = document.getElementById('displayImage');
    const icon = document.getElementById('placeholderIcon');
    if (data) { img.src = data; img.style.display = "block"; icon.style.display = "none"; }
    else { img.style.display = "none"; icon.style.display = "block"; }
}

function prepareNew() {
    isEditMode = false;
    document.getElementById('dbId').value = ""; // Clear DB ID
    document.querySelectorAll('.form-input').forEach(input => input.value = "");
    document.getElementById('photoPath').value = ""; updatePhotoUI("");
    document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
    lockFields(false);
    document.getElementById('exitDate').disabled = true;
    document.getElementById('modeStatus').innerHTML = '<i class="fas fa-plus-circle" style="color:#4ade80"></i> وضع الإدخال الجديد';
    document.getElementById('lastName').focus();
}

function enableEditing() {
    if (!document.getElementById('dbId').value && !document.getElementById('studentID').value) return alert("اختر تلميذاً.");
    if(!confirm("تفعيل وضع التعديل؟")) return;
    isEditMode = true; lockFields(false);
    document.getElementById('modeStatus').innerHTML = '<i class="fas fa-edit" style="color:#fbbf24"></i> وضع التعديل';
}

// CRUD Operations
async function saveCurrent() {
    // ... Validation Logic (Keep existing) ...
    const idVal = document.getElementById('studentID').value.trim();
    const phoneVal = document.getElementById('guardianPhone').value.trim();
    const dob = document.getElementById('dateOfBirth').value.trim();
    const enrollD = document.getElementById('enrollmentDate').value.trim();
    const exitD = document.getElementById('exitDate').value.trim();
    const enrollNum = document.getElementById('enrollmentNumber').value.trim();
    const classVal = document.getElementById('className').value.trim();

    const required = ['lastName','firstName','studentID','dateOfBirth','placeOfBirth','gender','academicYear','className','attendanceSystem','enrollmentDate','guardianName','motherName','guardianPhone','address'];
    for(let rid of required) { if(!document.getElementById(rid).value.trim()) { alert("يرجى ملء الحقول الإجبارية (*)"); return; } }

    if(!/^\d{16}$/.test(idVal)) { alert("رقم التعريف يجب أن يكون 16 رقماً."); return; }
    if(!/^0\d{9}$/.test(phoneVal)) { alert("الهاتف يجب أن يبدأ بـ 0 ويتكون من 10 أرقام."); return; }
    if(!/^\d{2} \/ \d{2} \/ \d{4}$/.test(dob)) { alert("تنسيق تاريخ الازدياد خاطئ."); return; }
    if(!/^\d{2} \/ \d{2} \/ \d{4}$/.test(enrollD)) { alert("تنسيق تاريخ التسجيل خاطئ."); return; }
    if(exitD && !/^\d{2} \/ \d{2} \/ \d{4}$/.test(exitD)) { alert("تنسيق تاريخ الخروج خاطئ."); return; }

    // Construct Payload
    const studentData = {
        student_id_number: idVal,
        last_name: document.getElementById('lastName').value,
        first_name: document.getElementById('firstName').value,
        gender: document.getElementById('gender').value,
        date_of_birth: toDjangoDate(dob),
        place_of_birth: document.getElementById('placeOfBirth').value,
        academic_year: document.getElementById('academicYear').value,
        class_name: classVal,
        attendance_system: document.getElementById('attendanceSystem').value,
        enrollment_number: enrollNum,
        enrollment_date: toDjangoDate(enrollD),
        exit_date: exitD ? toDjangoDate(exitD) : null,
        guardian_name: document.getElementById('guardianName').value,
        mother_name: document.getElementById('motherName').value,
        address: document.getElementById('address').value,
        guardian_phone: phoneVal,
        photo_path: document.getElementById('photoPath').value
    };

    const dbId = document.getElementById('dbId').value;
    let url = API_URL;
    let method = 'POST';

    if (isEditMode && dbId) {
        url += `${dbId}/`;
        method = 'PUT';
    }

    try {
        const res = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                // Add CSRF token if needed, usually DRF handles it if session auth, or ignore if public
            },
            body: JSON.stringify(studentData)
        });

        if (res.ok) {
            alert("تم الحفظ بنجاح!");
            fetchStudents(); // Refresh list
            lockFields(true);
            isEditMode = false;
        } else {
            const err = await res.json();
            alert("خطأ في الحفظ: " + JSON.stringify(err));
        }
    } catch (e) {
        console.error(e);
        alert("خطأ في الاتصال.");
    }
}

async function deleteStudent() {
    const dbId = document.getElementById('dbId').value;
    if (!dbId) return alert("اختر تلميذاً مسجلاً للحذف.");

    if (confirm("حذف التلميذ نهائياً من قاعدة البيانات؟")) {
        try {
            const res = await fetch(`${API_URL}${dbId}/`, { method: 'DELETE' });
            if (res.ok) {
                alert("تم الحذف.");
                fetchStudents();
                prepareNew(); // Clear form
            } else {
                alert("فشل الحذف.");
            }
        } catch (e) {
            alert("خطأ في الاتصال.");
        }
    }
}

async function bulkSave() {
    if(studentsList.length === 0) return alert("لا بيانات.");
    // Filter out already saved students (those with an 'id' that is a number (Django ID) - wait, imported ones have ID as string from excel)
    // Actually, safest is to try to POST all, and let unique constraints handle duplicates, or check first.
    // For simplicity: Loop and POST.

    if(!confirm("سيتم إرسال " + studentsList.length + " تلميذ إلى الخادم. هل أنت متأكد؟")) return;

    let successCount = 0;
    let failCount = 0;

    for (const s of studentsList) {
        // Map Local Object to Django Payload
        // Note: s.id from Excel is student_id_number, not Django PK.
        // We only POST new data.

        // Skip if it looks like a Django object (has numeric ID and created_at etc? No easy way to tell unless we tag them)
        // Assumption: If 'dbId' is set in the form logic, it's a django object. But here we are iterating list.
        // If the object has 'student_id_number' key, it's from Django (my render logic). If it has 'id' (from excel), it's local.

        if (s.student_id_number) continue; // Already from Django

        const payload = {
            student_id_number: s.id,
            last_name: s.ln,
            first_name: s.fn,
            gender: s.gender,
            date_of_birth: toDjangoDate(s.dob),
            place_of_birth: s.pob,
            academic_year: s.level,
            class_name: s.class,
            attendance_system: s.sys,
            enrollment_number: s.enrollNum,
            enrollment_date: toDjangoDate(s.enrollDate),
            exit_date: null,
            guardian_name: s.guard,
            mother_name: s.mother,
            address: s.addr,
            guardian_phone: s.phone,
            photo_path: ""
        };

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) successCount++;
            else failCount++;
        } catch (e) {
            failCount++;
        }
    }

    alert(`تمت العملية: ${successCount} نجاح, ${failCount} فشل/مكرر.`);
    fetchStudents(); // Refresh from server
}

function findVal(row, keys, excludeKeyword = null) {
    for (let k in row) {
        if (keys.some(key => k.includes(key))) {
            if (excludeKeyword && k.includes(excludeKeyword)) continue;
            return row[k];
        }
    }
    return "";
}

function importExcel() {
    let input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        let reader = new FileReader();
        reader.onload = ev => {
            let data = new Uint8Array(ev.target.result);
            let wb = XLSX.read(data, {type: 'array'});
            let json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames]);

            // Temporary list for preview
            const imported = json.map(row => ({
                id: String(findVal(row, ['تعريف', 'رقم'])), ln: findVal(row, ['اللقب']), fn: findVal(row, ['الاسم']),
                dob: formatStrictDate(findVal(row, ['ازدياد', 'ميلاد'])), gender: String(findVal(row, ['الجنس'])).trim(),
                level: findVal(row, ['السنة', 'المستوى'], 'التسجيل'), class: String(findVal(row, ['قسم'])),
                pob: findVal(row, ['مكان']), sys: findVal(row, ['نظام']), guard: findVal(row, ['ولي']),
                mother: findVal(row, ['أم']), phone: String(findVal(row, ['هاتف'])), addr: findVal(row, ['عنوان']),
                enrollNum: String(findVal(row, ['قيد'])), enrollDate: formatStrictDate(findVal(row, ['تاريخ التسجيل'])),
                exitDate: "", photo: ""
            }));

            studentsList = imported; // Show imported data
            renderTable();
            alert("تم استيراد " + studentsList.length + " تلميذ للمعاينة. اضغط 'حفظ الكل' لإرسالهم للخادم.");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };
    input.click();
}

function exportBackup() {
    window.open(API_URL + "?format=json", "_blank"); // Simple dump for now
}
</script>
</body>
</html>
