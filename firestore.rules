rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- User Profiles ---
    // Users can read their own profile (based on username stored in Firebase Auth UID)
    // OR if they are a 'director' (checked via custom claim or trusted field if implemented, here simplified to read-own)
    match /users_profiles/{username} {
      allow read: if request.auth != null && (request.auth.token.name == username || request.auth.uid == username);
      allow write: if false; // Only Admin SDK (Local App) can write
    }

    // --- Allowed Users Map (for Google Auth) ---
    // Readable by anyone authenticated to check if they are allowed?
    // Better: Readable only by the user themselves if the doc ID matches their email.
    match /allowed_users/{email_sanitized} {
      allow read: if request.auth != null; // Simplified for initial setup, ideal: check email match
      allow write: if false;
    }

    // --- Students ---
    // Readable by authenticated users (Parents & Employees)
    // Future: Restrict parents to specific students
    match /students/{studentId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // --- Attendance & Messages ---
    match /attendance/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    match /messages/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // --- Pending Updates (Write Only for Employees) ---
    match /pending_updates/{docId} {
      allow create: if request.auth != null;
      allow read: if false; // Only Admin SDK needs to read
    }
  }
}
