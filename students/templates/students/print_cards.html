{% extends 'base.html' %}
{% load static %}

{% block title %}طباعة البطاقات المدرسية{% endblock %}
{% block header_title %}طباعة البطاقات المدرسية{% endblock %}

{% block extra_css %}
<style>
    @media print {
        @page {
            size: A4;
            margin: 0;
        }
        body {
            background-color: white;
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }
        .sidebar, .header, .no-print {
            display: none !important;
        }
        .wrapper {
            display: block !important;
            height: auto !important;
            min-height: 0 !important;
        }
        .main {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }

        /* Container for each page (8 cards) */
        .print-page {
            width: 210mm;
            height: 297mm;
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr);
            padding: 10mm; /* Consistent margins */
            box-sizing: border-box;
            page-break-after: always;
            margin: 0 auto;
        }

        .print-page:last-child {
            page-break-after: auto;
        }
    }

    body {
        background-color: #f1f5f9;
    }

    /* Screen view styles */
    .print-page {
        width: 210mm;
        height: 297mm;
        background: white;
        margin: 20px auto;
        padding: 10mm;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: repeat(4, 1fr);
        gap: 5mm;
        box-sizing: border-box;
    }

    /* Business Card Size approx 85mm x 54mm */
    .id-card {
        border: 2px solid #1e40af;
        border-radius: 10px;
        padding: 5px;
        display: flex;
        flex-direction: row-reverse; /* Arabic Layout */
        overflow: hidden;
        background: url('{% static "img/card_bg_pattern.png" %}') no-repeat center center;
        background-size: cover;
        position: relative;
        height: 54mm; /* Exact height for fit */
        margin: auto; /* Center in grid cell */
        width: 88mm; /* Slightly wider than standard to fit grid nicely */
    }

    .photo-area {
        width: 35mm;
        height: 45mm;
        border: 1px solid #ccc;
        margin-left: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        border-radius: 6px;
        overflow: hidden;
    }

    .photo-area img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .info-area {
        flex: 1;
        text-align: right;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding-right: 5px;
    }

    .header-text {
        text-align: center;
        font-size: 10pt;
        font-weight: bold;
        color: #1e40af;
        border-bottom: 1px solid #1e40af;
        padding-bottom: 2px;
        margin-bottom: 2px;
    }

    .student-data {
        font-size: 10pt;
        line-height: 1.2;
    }
    .student-data strong {
        color: #333;
    }

    .barcode-area {
        text-align: center;
        margin-top: auto;
    }

    .barcode-area svg {
        max-width: 100%;
        height: 12mm;
    }

    .btn-float {
        position: fixed;
        bottom: 20px;
        left: 20px;
        padding: 15px 25px;
        font-size: 1.2rem;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}

<div class="no-print" style="text-align: center; margin-bottom: 20px;">
    <button onclick="window.print()" class="btn btn-primary btn-float"><i class="fas fa-print"></i> طباعة البطاقات</button>
    <a href="{% url 'students_management' %}" class="btn btn-secondary"><i class="fas fa-arrow-right"></i> رجوع</a>
</div>

{% for student in students %}
    <!-- Open new page every 8 cards -->
    {% if forloop.counter0|divisibleby:8 %}
    <div class="print-page">
    {% endif %}

    <div class="id-card">
        <div class="photo-area">
            {% if student.photo_path %}
            <img src="{{ student.photo_path }}">
            {% else %}
            <i class="fas fa-user fa-3x" style="color:#cbd5e1"></i>
            {% endif %}
        </div>

        <div class="info-area">
            <div class="header-text">
                متوسطة بوشنافة عمر<br>
                <span style="font-size: 8pt; font-weight: normal;">السنة الدراسية: 2026/2025</span>
            </div>

            <div class="student-data">
                <div><span style="color:#64748b; font-size: 8pt;">اللقب:</span> <strong>{{ student.last_name }}</strong></div>
                <div><span style="color:#64748b; font-size: 8pt;">الاسم:</span> <strong>{{ student.first_name }}</strong></div>
                <div><span style="color:#64748b; font-size: 8pt;">تاريخ الميلاد:</span> {{ student.date_of_birth|date:"Y/m/d" }}</div>
                <div><span style="color:#64748b; font-size: 8pt;">المستوى:</span> {{ student.academic_year }}</div>
                <!-- Logic to strip class name to number only.
                     Django template tag 'slice' or 'cut' is limited.
                     Ideally backend or custom filter.
                     Quick hack: Assuming class format "Year Number" -> Split and take last.
                     But pure template logic is hard.
                     Let's use a simple JS script to clean up AFTER rendering, OR
                     since we are in loop, we can't easily.
                     Actually, we can use a custom template tag OR
                     Assume the class_name is consistently formatted.
                     "أولى 1" -> "1".
                     We can try to just output it and rely on JS? No, print mode JS execution might be flaky or flash.
                     Best: Iterate and clean in View?
                     User asked for modifying the view/template.
                     I can't edit views.py right now for this specific context variable easily without re-reading it.
                     But I can try to use `cut` filter if the prefix is constant? No.
                     Let's rely on the fact that `student.class_name` contains the number at the end.
                     We can use `last` if it was a list.
                     Let's try to just render it and use JS to fix it immediately.
                -->
                <div><span style="color:#64748b; font-size: 8pt;">القسم:</span> <span class="class-name-clean">{{ student.class_name }}</span></div>
            </div>

            <div class="barcode-area">
                <svg class="barcode"
                     jsbarcode-format="CODE128"
                     jsbarcode-value="{{ student.student_id_number }}"
                     jsbarcode-textmargin="0"
                     jsbarcode-fontoptions="bold"
                     jsbarcode-height="30"
                     jsbarcode-displayValue="true"
                     jsbarcode-fontSize="10">
                </svg>
            </div>
        </div>
    </div>

    <!-- Close page div every 8 cards or at end -->
    {% if forloop.counter|divisibleby:8 or forloop.last %}
    </div>
    {% endif %}

{% endfor %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/JsBarcode.all.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        JsBarcode(".barcode").init();

        // Clean class names (e.g. "أولى 1" -> "1")
        document.querySelectorAll('.class-name-clean').forEach(span => {
            const full = span.textContent.trim();
            // Split by space and take last part
            const parts = full.split(' ');
            if (parts.length > 1) {
                span.textContent = parts[parts.length - 1];
            }
        });
    });
</script>
{% endblock %}
