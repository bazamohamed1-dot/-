{% extends 'base.html' %}
{% load static %}

{% block title %}تسيير التلاميذ - قاعدة البيانات{% endblock %}

{% block header_title %}تسيير التلاميذ - قاعدة البيانات{% endblock %}

{% block extra_css %}
<style>
    /* Scoped styles for the management interface */
    .photo-card { width: 140px; height: 170px; border: 2px solid #e2e8f0; background: #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin: auto; overflow: hidden; position: relative; }
    .photo-card img { width: 100%; height: 100%; object-fit: cover; display: none; }

    .main-form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .field-box { display: flex; flex-direction: column; gap: 5px; min-width: 0; }
    /* Responsive grid for mobile */
    @media (max-width: 768px) {
        .main-form { grid-template-columns: 1fr; }
        .span-2 { grid-column: span 1 !important; }
        .layout-grid { grid-template-columns: 1fr !important; }
        .action-tray { flex-direction: column; }
        .action-tray .btn { width: 100%; }
        /* Photo card centered on mobile */
        .sidebar-photo-container { border-left: none; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 20px; }
        /* Filter stack */
        .search-box, .filter-input { width: 100% !important; margin-bottom: 5px; }
        #filterContainer { flex-direction: column; }
        .mobile-only { display: inline-flex !important; }
    }
    .field-box label { font-size: 0.85rem; font-weight: 700; color: #64748b; }
    .field-box input, .field-box select { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.95rem; outline: none; background: #fff; width: 100%; box-sizing: border-box; }
    /* Force Western numerals for date inputs */
    input[type="date"] { direction: ltr !important; text-align: right; font-family: 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif, 'Cairo'; unicode-bidi: plaintext; }
    .span-2 { grid-column: span 2; }

    .action-tray { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }

    .table-container { max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
    .selected-row { background: #e0f2fe !important; border-right: 4px solid var(--primary); }
    .disabled-field { background-color: #f1f5f9 !important; cursor: not-allowed; color: #64748b; }

    /* Sidebar photo area */
    .sidebar-photo-container { display: flex; flex-direction: column; gap: 10px; align-items: center; padding: 10px; border-left: 1px solid #e2e8f0; }

    .layout-grid { display: grid; grid-template-columns: 200px 1fr; gap: 20px; }

    #editBtn { background-color: #f59e0b; color: white; display: none; }

    /* Search Bar */
    .search-box { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1rem; }
    .search-box:focus { border-color: var(--primary); outline: none; }
    /* Filter Selects */
    .filter-input { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.95rem; outline: none; background: #fff; width: 100%; box-sizing: border-box; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="layout-grid">
        <!-- Photo Sidebar -->
        <div class="sidebar-photo-container">
            <div class="photo-card" id="photoFrame">
                <i class="fas fa-user fa-3x" id="placeholderIcon" style="color:#e2e8f0"></i>
                <img id="displayImage">
            </div>
            <!-- File Input for Gallery -->
            <input type="file" id="imageSelector" style="display:none" accept="image/*" onchange="handleImageSelection(this)">
            <!-- File Input for Native Camera -->
            <input type="file" id="nativeCameraInput" style="display:none" accept="image/*" capture="environment" onchange="handleImageSelection(this)">

            <button class="btn btn-primary" id="photoBtn" style="width:100%; background:#e2e8f0; color:#333;" onclick="triggerImageSelect()">
                <i class="fas fa-upload"></i> تنزيل صورة (المعرض)
            </button>
            <button class="btn btn-secondary" id="cameraBtn" style="width:100%; background:#e2e8f0; color:#333; margin-top:5px;" onclick="triggerNativeCamera()">
                <i class="fas fa-camera"></i> التقاط بالكاميرا
            </button>
            <button class="btn btn-danger" id="deletePhotoBtn" style="width:100%; display:none;" onclick="removePhotoImage()">
                <i class="fas fa-trash-alt"></i> حذف
            </button>

            <div style="margin-top: 20px; text-align: center;">
                <span id="modeStatus" style="font-weight: bold; font-size: 0.9rem; color: var(--secondary);">
                    <i class="fas fa-eye"></i> وضع العرض
                </span>
            </div>
        </div>

        <!-- Form Area -->
        <div>
            <div class="main-form" id="studentForm">
                <div class="field-box"><label>اللقب *</label><input type="text" id="lastName" class="form-input"></div>
                <div class="field-box"><label>الاسم *</label><input type="text" id="firstName" class="form-input"></div>
                <div class="field-box"><label>رقم التعريف (16 رقم) *</label><input type="text" id="studentID" maxlength="16" class="form-input"></div>
                <div class="field-box"><label>تاريخ الازدياد *</label><input type="date" id="dateOfBirth" class="form-input" lang="fr-FR"></div>

                <div class="field-box"><label>مكان الميلاد *</label><input type="text" id="placeOfBirth" class="form-input"></div>
                <div class="field-box"><label>الجنس *</label>
                    <select id="gender" class="form-input">
                        <option value="">اختر...</option><option value="ذكر">ذكر</option><option value="أنثى">أنثى</option>
                    </select>
                </div>
                <div class="field-box"><label>المستوى *</label>
                    <select id="academicYear" class="form-input">
                        <option value="">اختر...</option><option value="أولى">أولى</option><option value="ثانية">ثانية</option><option value="ثالثة">ثالثة</option><option value="رابعة">رابعة</option>
                    </select>
                </div>
                <div class="field-box"><label>القسم (مثال: 1) *</label><input type="text" id="className" class="form-input"></div>

                <div class="field-box"><label>نظام التمدرس *</label>
                    <select id="attendanceSystem" class="form-input">
                        <option value="خارجي">خارجي</option><option value="نصف داخلي">نصف داخلي</option>
                    </select>
                </div>
                <div class="field-box"><label>رقم القيد</label><input type="text" id="enrollmentNumber" class="form-input"></div>
                <div class="field-box"><label>تاريخ التسجيل *</label><input type="date" id="enrollmentDate" class="form-input" lang="fr-FR"></div>
                <div class="field-box"><label>تاريخ الخروج</label><input type="date" id="exitDate" class="form-input" lang="fr-FR"></div>

                <div class="field-box span-2"><label>اسم الولي الكامل</label><input type="text" id="guardianName" class="form-input"></div>
                <div class="field-box span-2"><label>لقب واسم الأم</label><input type="text" id="motherName" class="form-input"></div>
                <div class="field-box span-2"><label>رقم هاتف الولي</label><input type="text" id="guardianPhone" class="form-input" maxlength="10"></div>
                <div class="field-box span-2"><label>عنوان السكن</label><input type="text" id="address" class="form-input"></div>
                <input type="hidden" id="photoPath">
                <input type="hidden" id="dbId"> <!-- Django ID -->
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-tray">
        {% if is_director or 'student_add' in permissions %}
        <button class="btn btn-success" onclick="prepareNew()"><i class="fas fa-plus"></i> جديد</button>
        <button class="btn btn-primary" onclick="saveCurrent()"><i class="fas fa-save"></i> حفظ</button>
        {% endif %}

        {% if is_director or 'student_edit' in permissions %}
        <button class="btn" id="editBtn" onclick="enableEditing()"><i class="fas fa-edit"></i> تعديل</button>
        <button class="btn btn-warning" id="cancelEditBtn" style="display:none;" onclick="cancelEditing()"><i class="fas fa-times"></i> إلغاء التعديل</button>
        {% endif %}

        {% if is_director or 'student_delete' in permissions %}
        <button class="btn btn-danger" onclick="deleteStudent()"><i class="fas fa-trash"></i> حذف</button>
        {% endif %}

        <div style="flex-grow: 1;"></div>

        {% if is_director or 'import_data' in permissions %}
        <button class="btn" style="background:#334155; color:white" onclick="exportBackup()"><i class="fas fa-database"></i> نسخة احتياطية</button>
        {% endif %}

        {% if is_director or 'student_print' in permissions %}
        <button class="btn" style="background:#4f46e5; color:white" onclick="submitPrint()"><i class="fas fa-id-card"></i> طباعة البطاقات</button>
        {% endif %}
    </div>

    <!-- Search and Filter -->
    <!-- Filters enabled always as requested -->
    <div id="filterContainer" style="display: flex; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="searchInput" class="search-box" placeholder="ابحث بالاسم أو رقم التعريف..." onkeyup="filterTable()" style="margin-bottom: 0; flex: 2;">

        <select id="filterLevel" class="filter-input" style="flex: 1;" onchange="filterTable()">
            <option value="">جميع المستويات</option>
            <!-- Populated via JS -->
        </select>

        <select id="filterClass" class="filter-input" style="flex: 1;" onchange="filterTable()">
            <option value="">جميع الأقسام</option>
            <!-- Populated via JS -->
        </select>
    </div>

    <!-- Table -->
    <div class="table-container">
        <form id="printForm" action="{% url 'print_student_cards' %}" method="POST">
            {% csrf_token %}
            <table id="studentsTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" onclick="toggleSelectAll(this)"></th>
                        <th>رقم التعريف</th>
                        <th>اللقب</th>
                        <th>الاسم</th>
                        <th>تاريخ الازدياد</th>
                        <th>المستوى</th>
                        <th>القسم</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/xlsx.full.min.js' %}"></script>
<script>
let studentsList = [];
let filteredList = [];
let selectedIndex = -1;
let isEditMode = false;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    fetchStudents();
    lockFields(true);

    // Click outside to cancel edit
    document.addEventListener('click', function(event) {
        const form = document.getElementById('studentForm');
        const tray = document.querySelector('.action-tray');
        const table = document.querySelector('.table-container');
        const sidebar = document.querySelector('.sidebar-photo-container');
        const cameraModal = document.getElementById('cameraModal');

        // Prevent triggering when interacting with camera modal
        if (cameraModal.style.display !== 'none' && cameraModal.contains(event.target)) return;

        // If click is NOT inside form, tray, table, or sidebar, and we are in Edit Mode
        if (isEditMode && !form.contains(event.target) && !tray.contains(event.target) && !table.contains(event.target) && !sidebar.contains(event.target)) {
            // Disabled persistent nagging as requested
            // if (confirm("إلغاء التعديل؟")) { ... }
        }
    });
});

async function fetchStudents() {
    try {
        let data = [];
        let usedOffline = false;

        const response = await fetch('/api/students/');
        if (!response.ok) throw new Error('Network response was not ok');
        data = await response.json();

        studentsList = data.map(s => ({
            dbId: s.id,
            id: s.student_id_number,
            ln: s.last_name,
            fn: s.first_name,
            dob: s.date_of_birth,
            pob: s.place_of_birth,
            gender: s.gender,
            level: s.academic_year,
            class: s.class_name,
            sys: s.attendance_system,
            enrollNum: s.enrollment_number,
            enrollDate: s.enrollment_date,
            exitDate: s.exit_date,
            guard: s.guardian_name,
            mother: s.mother_name,
            phone: s.guardian_phone,
            addr: s.address,
            photo: s.photo_path
        }));

        populateFilters();
        filteredList = studentsList;
        renderTable();
    } catch (error) {
        console.error('Error fetching students:', error);
        alert('حدث خطأ أثناء تحميل البيانات');
    }
}

function lockFields(lock) {
    document.querySelectorAll('.form-input').forEach(input => {
        input.disabled = lock;
        input.classList.toggle('disabled-field', lock);
    });
    document.getElementById('photoBtn').disabled = lock;
    document.getElementById('photoBtn').style.opacity = lock ? "0.5" : "1";
    document.getElementById('cameraBtn').disabled = lock;
    document.getElementById('cameraBtn').style.opacity = lock ? "0.5" : "1";
    document.getElementById('deletePhotoBtn').style.display = (!lock && isEditMode) ? "block" : "none";
}

function prepareNew() {
    if (isEditMode && !confirm("هل أنت متأكد من إلغاء التعديل الحالي؟")) return;

    isEditMode = false;
    selectedIndex = -1;
    document.querySelectorAll('.form-input').forEach(input => input.value = "");
    document.getElementById('dbId').value = "";
    document.getElementById('photoPath').value = "";
    updatePhotoUI("");

    document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
    lockFields(false);
    document.getElementById('editBtn').style.display = 'none';
    document.getElementById('modeStatus').innerHTML = '<i class="fas fa-plus-circle" style="color:#10b981"></i> وضع الإدخال الجديد';
    document.getElementById('lastName').focus();
}

function enableEditing() {
    if (selectedIndex === -1) return alert("الرجاء اختيار تلميذ من القائمة أولاً");
    isEditMode = true;
    lockFields(false);
    document.getElementById('editBtn').style.display = 'none';
    document.getElementById('cancelEditBtn').style.display = 'inline-flex';
    document.getElementById('modeStatus').innerHTML = '<i class="fas fa-edit" style="color:#f59e0b"></i> وضع التعديل';
}

function fillForm(idx, row) {
    // Suppress confirmation message as requested by user
    // if (isEditMode && !confirm("هل تريد تجاهل التغييرات غير المحفوظة؟")) return;

    selectedIndex = idx;
    const s = filteredList[idx]; // Use filtered list index

    document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
    if(row) row.classList.add('selected-row');

    document.getElementById('dbId').value = s.dbId;
    document.getElementById('lastName').value = s.ln;
    document.getElementById('firstName').value = s.fn;
    document.getElementById('studentID').value = s.id;
    document.getElementById('dateOfBirth').value = s.dob;
    document.getElementById('placeOfBirth').value = s.pob;
    document.getElementById('gender').value = s.gender;
    document.getElementById('academicYear').value = s.level;

    let classNum = s.class;
    if (s.class && s.class.includes(s.level)) {
        classNum = s.class.replace(s.level, '').trim();
    }
    document.getElementById('className').value = classNum;

    document.getElementById('attendanceSystem').value = s.sys;
    document.getElementById('enrollmentNumber').value = s.enrollNum;
    document.getElementById('enrollmentDate').value = s.enrollDate;
    document.getElementById('exitDate').value = s.exitDate;
    document.getElementById('guardianName').value = s.guard;
    document.getElementById('motherName').value = s.mother;
    document.getElementById('guardianPhone').value = s.phone;
    document.getElementById('address').value = s.addr;

    document.getElementById('photoPath').value = s.photo || "";
    updatePhotoUI(s.photo);

    lockFields(true);
    isEditMode = false;
    document.getElementById('editBtn').style.display = 'inline-flex';
    document.getElementById('cancelEditBtn').style.display = 'none';
    document.getElementById('modeStatus').innerHTML = '<i class="fas fa-eye"></i> وضع العرض';
}

function cancelEditing() {
    if(!confirm('هل تريد إلغاء التعديلات؟')) return;

    // Disable edit mode first to prevent double confirmation in fillForm
    isEditMode = false;

    // Revert to view mode for the selected student
    fillForm(selectedIndex, document.querySelector('.selected-row'));
}

async function saveCurrent() {
    // Validation
    const required = ['lastName', 'firstName', 'studentID', 'academicYear', 'className'];
    for (let id of required) {
        if (!document.getElementById(id).value.trim()) {
            alert("يرجى ملء الحقول الإجبارية (اللقب، الاسم، رقم التعريف، المستوى، القسم)");
            return;
        }
    }

    const level = document.getElementById('academicYear').value;
    const classNum = document.getElementById('className').value.trim();
    const fullClass = `${level} ${classNum}`;

    const studentData = {
        student_id_number: document.getElementById('studentID').value.trim(),
        last_name: document.getElementById('lastName').value.trim(),
        first_name: document.getElementById('firstName').value.trim(),
        gender: document.getElementById('gender').value,
        date_of_birth: document.getElementById('dateOfBirth').value || null,
        place_of_birth: document.getElementById('placeOfBirth').value,
        academic_year: level,
        class_name: fullClass,
        attendance_system: document.getElementById('attendanceSystem').value,
        enrollment_number: document.getElementById('enrollmentNumber').value,
        enrollment_date: document.getElementById('enrollmentDate').value || new Date().toISOString().split('T')[0],
        exit_date: document.getElementById('exitDate').value || null,
        guardian_name: document.getElementById('guardianName').value,
        mother_name: document.getElementById('motherName').value,
        guardian_phone: document.getElementById('guardianPhone').value,
        address: document.getElementById('address').value,
        photo_path: document.getElementById('photoPath').value
    };

    const dbId = document.getElementById('dbId').value;
    const method = (dbId && dbId !== "undefined" && dbId !== "") ? 'PUT' : 'POST';
    const url = (dbId && dbId !== "undefined" && dbId !== "") ? `/api/students/${dbId}/` : '/api/students/';

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(studentData)
        });

        if (response.ok) {
            const result = await response.json();

            if (response.status === 202) {
                alert(result.message || "تم إرسال التحديث للموافقة");
            } else {
                alert("تم الحفظ بنجاح");
            }

            // Turn off edit mode immediately to prevent "Ignore changes?" prompt in fillForm
            isEditMode = false;

            // Only refresh list immediately if it was a direct save (Director)
            if (response.status !== 202) {
                await fetchStudents();
            }

            if (dbId && dbId !== "undefined" && dbId !== "") {
                 // Update the current view
                 if (response.status !== 202) {
                     filterTable();
                     const newIdx = filteredList.findIndex(s => s.dbId == dbId);
                     if (newIdx !== -1) {
                         const rows = document.querySelectorAll('#studentsTable tbody tr');
                         if (rows[newIdx]) fillForm(newIdx, rows[newIdx]);
                     } else {
                         prepareNew();
                     }
                 } else {
                     // If pending, maybe just reset form?
                     prepareNew();
                 }
            } else {
                 prepareNew();
            }
        } else {
            const err = await response.json();
            alert("خطأ في الحفظ: " + JSON.stringify(err));
        }
    } catch (error) {
        console.error('Error:', error);
        alert("حدث خطأ في الاتصال");
    }
}

async function deleteStudent() {
    // Get all checked checkboxes
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    if (checkboxes.length === 0) {
        alert("يرجى تحديد تلاميذ");
        return;
    }

    if (!confirm(`هل أنت متأكد من حذف ${checkboxes.length} تلميذ؟`)) return;

    const ids = Array.from(checkboxes).map(cb => cb.value);

    try {
        const response = await fetch('/api/students/bulk_delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ ids: ids })
        });

        if (response.ok) {
            alert("تم الحذف بنجاح");
            fetchStudents();
            prepareNew();
        } else {
            alert("حدث خطأ أثناء الحذف");
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال");
    }
}

function populateFilters() {
    // Populate Levels
    const levelSelect = document.getElementById('filterLevel');
    const levels = [...new Set(studentsList.map(s => s.level).filter(l => l))].sort();
    const selectedLevel = levelSelect.value;

    levelSelect.innerHTML = '<option value="">جميع المستويات</option>';
    levels.forEach(l => {
        const option = document.createElement('option');
        option.value = l;
        option.textContent = l;
        levelSelect.appendChild(option);
    });
    levelSelect.value = selectedLevel;

    // Populate Classes
    const classSelect = document.getElementById('filterClass');
    const classes = [...new Set(studentsList.map(s => s.class).filter(c => c))].sort();
    const selectedClass = classSelect.value;

    classSelect.innerHTML = '<option value="">جميع الأقسام</option>';
    classes.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c;
        classSelect.appendChild(option);
    });
    classSelect.value = selectedClass;
}

function filterTable() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const levelFilter = document.getElementById('filterLevel').value;
    const classFilter = document.getElementById('filterClass').value;

    filteredList = studentsList.filter(s => {
        const matchesSearch = s.ln.toLowerCase().includes(query) ||
                              s.fn.toLowerCase().includes(query) ||
                              s.id.includes(query);
        const matchesLevel = levelFilter ? s.level === levelFilter : true;
        const matchesClass = classFilter ? s.class === classFilter : true;

        return matchesSearch && matchesLevel && matchesClass;
    });
    renderTable();
}

function renderTable() {
    const tbody = document.querySelector('#studentsTable tbody');
    tbody.innerHTML = filteredList.map((s, i) => {
        // Strip level from class name if present (e.g. "أولى 1" -> "1")
        let shortClass = s.class;
        if (s.level && shortClass && shortClass.includes(s.level)) {
            shortClass = shortClass.replace(s.level, '').trim();
        }

        return `
        <tr onclick="fillForm(${i}, this)">
            <td onclick="event.stopPropagation()">
                <input type="checkbox" name="student_ids" value="${s.dbId}" class="row-checkbox">
            </td>
            <td>${s.id}</td>
            <td>${s.ln}</td>
            <td>${s.fn}</td>
            <td style="direction:ltr; font-family: 'Segoe UI', sans-serif;">${s.dob || ''}</td>
            <td>${s.level}</td>
            <td>${shortClass}</td>
        </tr>
        `;
    }).join('');
}

function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = source.checked);
}

function submitPrint() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    if (checkboxes.length === 0) {
        alert("يرجى اختيار تلميذ واحد على الأقل للطباعة");
        return;
    }
    document.getElementById('printForm').submit();
}

// Helper to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function exportBackup() {
    if (studentsList.length === 0) return alert("لا توجد بيانات للتصدير");

    const backupData = studentsList.map(s => ({
        "رقم التعريف الوطني": s.id,
        "اللقب": s.ln,
        "الاسم": s.fn,
        "تاريخ الازدياد": s.dob,
        "مكان الميلاد": s.pob,
        "الجنس": s.gender,
        "المستوى": s.level,
        "القسم": s.class,
        "نظام التمدرس": s.sys,
        "رقم القيد": s.enrollNum,
        "تاريخ التسجيل": s.enrollDate,
        "تاريخ الخروج": s.exitDate,
        "اسم الولي": s.guard,
        "اسم الأم": s.mother,
        "هاتف الولي": s.phone,
        "العنوان": s.addr,
        "مسار الصورة": s.photo // Added photo path
    }));

    const ws = XLSX.utils.json_to_sheet(backupData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "التلاميذ");
    XLSX.writeFile(wb, "Backup_Students.xlsx");
}

function triggerImageSelect() { document.getElementById('imageSelector').click(); }
function triggerNativeCamera() { document.getElementById('nativeCameraInput').click(); }

function handleImageSelection(input) {
    if (input.files && input.files[0]) {
        // Keep file in imageSelector for potential offline saving (Blob)
        // If nativeCameraInput triggered this, we might want to copy file reference if possible,
        // but inputs are read-only.
        // Solution: `saveCurrent` checks BOTH inputs.

        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('photoPath').value = e.target.result;
            updatePhotoUI(e.target.result);
        };
        reader.readAsDataURL(input.files[0]);
    }
}
function removePhotoImage() {
    document.getElementById('photoPath').value = "";
    document.getElementById('imageSelector').value = ""; // Clear file inputs
    document.getElementById('nativeCameraInput').value = "";
    updatePhotoUI("");
}
function updatePhotoUI(data) {
    const img = document.getElementById('displayImage');
    const icon = document.getElementById('placeholderIcon');
    if (data) { img.src = data; img.style.display = "block"; icon.style.display = "none"; }
    else { img.style.display = "none"; icon.style.display = "block"; }
}
</script>
{% endblock %}
