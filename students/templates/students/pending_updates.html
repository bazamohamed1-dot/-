{% extends 'base.html' %}
{% load static %}

{% block title %}تسيير التلاميذ - مركز المراجعة{% endblock %}

{% block header_title %}مركز المراجعة{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">البيانات المعلقة ({{ updates|length }})</h3>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="approveAll()"><i class="fas fa-check-double"></i> موافقة على الكل</button>
            <button class="btn btn-danger" onclick="rejectAll()"><i class="fas fa-trash"></i> رفض الكل</button>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <table id="updatesTable">
            <thead>
                <tr>
                    <th>المستخدم</th>
                    <th>النوع</th>
                    <th>الإجراء</th>
                    <th>البيانات</th>
                    <th>التاريخ</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for update in updates %}
                <tr id="row-{{ update.id }}">
                    <td>{{ update.user.username }}</td>
                    <td>
                        {% if update.model_name|lower == 'student' %}تلميذ
                        {% elif update.model_name == 'CanteenAttendance' %}حضور مطعم
                        {% elif update.model_name == 'LibraryLoan' %}إعارة كتاب
                        {% else %}{{ update.model_name }}{% endif %}
                    </td>
                    <td>
                        {% if update.action == 'create' %}<span class="badge bg-success">إضافة</span>
                        {% elif update.action == 'update' %}<span class="badge bg-warning text-dark">تعديل</span>
                        {% elif update.action == 'delete' %}<span class="badge bg-danger">حذف</span>
                        {% else %}{{ update.action }}{% endif %}
                    </td>
                    <td style="max-width: 400px;">
                        <div class="data-preview">
                            {% if update.model_name|lower == 'student' %}
                                {% with payload=update.data %}
                                    <strong>{{ payload.last_name }} {{ payload.first_name }}</strong><br>
                                    <small class="text-muted">{{ payload.class_name }}</small>
                                    {% if payload.photo_path and payload.photo_path|slice:":10" == "data:image" %}
                                        <div style="margin-top: 5px;">
                                            <img src="{{ payload.photo_path }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% elif update.model_name == 'CanteenAttendance' %}
                                {% with payload=update.data.data %}
                                    مسح باركود: {{ payload.barcode }}
                                {% endwith %}
                            {% else %}
                                <pre style="font-size: 0.8rem; background: #f8f9fa; padding: 5px;">{{ update.data.data|pprint }}</pre>
                            {% endif %}
                        </div>
                    </td>
                    <td dir="ltr">{{ update.timestamp|date:"Y-m-d H:i" }}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="approveUpdate({{ update.id }})" title="موافقة"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="rejectUpdate({{ update.id }})" title="رفض"><i class="fas fa-times"></i></button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">لا توجد تحديثات معلقة.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: white; }
    .bg-success { background-color: #10b981; }
    .bg-warning { background-color: #f59e0b; }
    .bg-danger { background-color: #ef4444; }
    .text-dark { color: #1f2937; }
    .text-muted { color: #6b7280; }
    .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
</style>
{% endblock %}

{% block extra_js %}
<script>
    async function approveUpdate(id) {
        if (!confirm("هل أنت متأكد من الموافقة على هذا التحديث؟")) return;
        try {
            const res = await fetch(`/api/pending_updates/${id}/approve/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('baza_school_csrf_v2') }
            });
            if (res.ok) {
                document.getElementById(`row-${id}`).remove();
                checkEmpty();
            } else {
                alert("حدث خطأ أثناء الموافقة");
            }
        } catch (e) { console.error(e); alert("خطأ في الاتصال"); }
    }

    async function rejectUpdate(id) {
        if (!confirm("هل أنت متأكد من رفض وحذف هذا التحديث؟")) return;
        try {
            const res = await fetch(`/api/pending_updates/${id}/`, { // DELETE endpoint on ViewSet
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCookie('baza_school_csrf_v2') }
            });
            if (res.ok) {
                document.getElementById(`row-${id}`).remove();
                checkEmpty();
            } else {
                alert("حدث خطأ أثناء الرفض");
            }
        } catch (e) { console.error(e); alert("خطأ في الاتصال"); }
    }

    async function approveAll() {
        if (!confirm("هل أنت متأكد من الموافقة على جميع التحديثات؟")) return;
        try {
            const res = await fetch(`/api/pending_updates/approve_all/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('baza_school_csrf_v2') }
            });
            if (res.ok) {
                location.reload();
            } else {
                alert("حدث خطأ أثناء العملية");
            }
        } catch (e) { console.error(e); alert("خطأ في الاتصال"); }
    }

    async function rejectAll() {
        if (!confirm("هل أنت متأكد من رفض جميع التحديثات؟")) return;
        try {
            const res = await fetch(`/api/pending_updates/reject_all/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('baza_school_csrf_v2') }
            });
            if (res.ok) {
                location.reload();
            } else {
                alert("حدث خطأ أثناء العملية");
            }
        } catch (e) { console.error(e); alert("خطأ في الاتصال"); }
    }

    function checkEmpty() {
        const tbody = document.querySelector('tbody');
        if (tbody.children.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">لا توجد تحديثات معلقة.</td></tr>';
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
