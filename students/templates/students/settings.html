{% extends 'base.html' %}
{% load static %}

{% block title %}الإعدادات والصلاحيات{% endblock %}
{% block header_title %}الإعدادات العامة والصلاحيات{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-school"></i> بيانات المؤسسة</h3>
    <form id="schoolSettingsForm" onsubmit="saveSchoolSettings(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">اسم المؤسسة</label>
                <input type="text" id="schoolName" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">السنة الدراسية</label>
                <input type="text" id="academicYear" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">اسم المدير</label>
                <input type="text" id="directorName" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">بريد المدير (للاستعادة)</label>
                <input type="email" id="adminEmail" class="form-input" style="width:100%; padding:10px; direction:ltr; text-align:left;">
            </div>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ الإعدادات</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-book"></i> إعدادات المكتبة</h3>
    <form id="librarySettingsForm" onsubmit="saveLibrarySettings(event)">
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
             <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">الحد الأقصى للإعارات</label>
                <input type="number" id="loanLimit" class="form-input western-nums" required style="width:100%; padding:10px; direction: ltr;" min="1" value="2">
            </div>
        </div>
         <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ إعدادات المكتبة</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-database"></i> إدارة قاعدة البيانات</h3>
    <div style="padding: 10px 0;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="btn btn-info" style="background:#0891b2; color:white" onclick="document.getElementById('importFile').click()">
                <i class="fas fa-file-import"></i> استيراد التلاميذ من ملف Excel
            </button>
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="updateExisting" name="update_existing" style="width:20px; height:20px;">
                <label for="updateExisting" style="margin-right:8px; cursor:pointer;">تحديث البيانات الموجودة</label>
            </div>
        </div>
        <input type="file" id="importFile" style="display:none;" onchange="submitImport()">
        <p style="margin-top:10px; color:#64748b; font-size:0.9rem;">
            * يرجى استخدام ملف Eleve.xls الأصلي لاستيراد البيانات بشكل صحيح.
        </p>
    </div>
</div>

<!-- User Management Section -->
<div class="card" id="userManagementSection" style="display:none; margin-bottom: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
        <h3><i class="fas fa-users-cog"></i> إدارة المستخدمين</h3>
        <div style="display:flex; gap:10px;">
             <button class="btn btn-primary" onclick="openLogsModal()"><i class="fas fa-history"></i> سجل الدخول والخروج</button>
             <button class="btn btn-success" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة مستخدم</button>
        </div>
    </div>

    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr style="background:#f8fafc; text-align:right;">
                <th style="padding:10px;">اسم المستخدم</th>
                <th style="padding:10px;">الدور</th>
                <th style="padding:10px;">الحالة</th>
                <th style="padding:10px;">المحاولات</th>
                <th style="padding:10px;">إجراءات</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            <!-- Populated via JS -->
        </tbody>
    </table>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div class="card" style="width:400px; padding:20px;">
        <h3 id="userModalTitle" style="margin-bottom:20px;">إضافة مستخدم</h3>
        <form id="userForm">
            <input type="hidden" id="editUserId">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">اسم المستخدم</label>
                <input type="text" id="uUsername" class="form-input western-nums" style="width:100%; padding:10px; direction:ltr; text-align:left;" required>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">كلمة المرور</label>
                <input type="password" id="uPassword" class="form-input western-nums" style="width:100%; padding:10px; direction:ltr; text-align:left;">
                <small style="color:#666; display:none;" id="pwdHint">اتركه فارغاً إذا لم ترد التغيير</small>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">الدور</label>
                <select id="uRole" class="form-input" style="width:100%; padding:10px;" required>
                    <option value="librarian">مكتبي</option>
                    <option value="storekeeper">مخزني (مطعم)</option>
                    <option value="archivist">أرشيفي</option>
                    <option value="secretariat">أمانة</option>
                    <option value="director">مدير</option>
                </select>
            </div>

            <div style="margin-bottom:15px; border-top:1px solid #eee; padding-top:10px;">
                <label style="display:block; margin-bottom:10px; font-weight:bold;">الصلاحيات التفصيلية</label>

                <div style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-utensils"></i> المطعم</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_canteen" id="perm_canteen_access"> <label for="perm_canteen_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_scan" id="perm_canteen_scan"> <label for="perm_canteen_scan">مسح البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_manual" id="perm_canteen_manual"> <label for="perm_canteen_manual">إدخال يدوي</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_export" id="perm_canteen_export"> <label for="perm_canteen_export">تصدير القوائم</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-book"></i> المكتبة</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_library" id="perm_lib_access"> <label for="perm_lib_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_scan" id="perm_lib_scan"> <label for="perm_lib_scan">مسح البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_loan" id="perm_lib_loan"> <label for="perm_lib_loan">إعارة الكتب</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_return" id="perm_lib_return"> <label for="perm_lib_return">إرجاع الكتب</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_readers_list" id="perm_lib_readers"> <label for="perm_lib_readers">قائمة القراء (حذف)</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-user-graduate"></i> التلاميذ</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_management" id="perm_std_access"> <label for="perm_std_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_add" id="perm_std_add"> <label for="perm_std_add">إضافة تلميذ</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_edit" id="perm_std_edit"> <label for="perm_std_edit">تعديل بيانات</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_delete" id="perm_std_del"> <label for="perm_std_del">حذف تلاميذ</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_print" id="perm_std_print"> <label for="perm_std_print">طباعة البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="import_data" id="perm_std_import"> <label for="perm_std_import">استيراد البيانات</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-cog"></i> الإدارة</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="manage_users" id="perm_adm_users"> <label for="perm_adm_users">إدارة المستخدمين</label></div>
                             <div><input type="checkbox" class="perm-check" value="manage_settings" id="perm_adm_settings"> <label for="perm_adm_settings">الإعدادات العامة</label></div>
                             <div><input type="checkbox" class="perm-check" value="access_archive" id="perm_archive"> <label for="perm_archive">الأرشيف</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="submit" class="btn btn-primary" style="flex:1;">حفظ</button>
                <button type="button" class="btn btn-danger" onclick="closeUserModal()" style="flex:1;">إلغاء</button>
            </div>
        </form>
    </div>
</div>

<!-- Logs Modal -->
<div id="logsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div class="card" style="width:600px; padding:20px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
             <h3 style="margin:0;">سجل نشاط المستخدمين</h3>
             <button class="btn btn-danger" onclick="clearLogs()"><i class="fas fa-trash"></i> محو السجل</button>
        </div>
        <table style="width:100%; border-collapse: collapse;">
             <thead>
                 <tr style="background:#f1f5f9; text-align:right;">
                     <th style="padding:8px;">المستخدم</th>
                     <th style="padding:8px;">النشاط</th>
                     <th style="padding:8px;">التوقيت</th>
                 </tr>
             </thead>
             <tbody id="logsTableBody">
                 <tr><td colspan="3">جاري التحميل...</td></tr>
             </tbody>
        </table>
        <div style="text-align:center; margin-top:20px;">
             <button class="btn btn-secondary" onclick="document.getElementById('logsModal').style.display='none'">إغلاق</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    loadUsers();
});

async function loadSettings() {
    try {
        const response = await fetch('/canteen/settings/data/');
        const data = await response.json();

        if (data.name) document.getElementById('schoolName').value = data.name;
        if (data.academic_year) document.getElementById('academicYear').value = data.academic_year;
        if (data.director_name) document.getElementById('directorName').value = data.director_name;
        if (data.loan_limit) document.getElementById('loanLimit').value = data.loan_limit;
        if (data.admin_email) document.getElementById('adminEmail').value = data.admin_email;
    } catch (error) {
        console.error("Error loading settings", error);
    }
}

async function saveSchoolSettings(e) {
    e.preventDefault();
    const data = {
        name: document.getElementById('schoolName').value,
        academic_year: document.getElementById('academicYear').value,
        director_name: document.getElementById('directorName').value,
        admin_email: document.getElementById('adminEmail').value
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المؤسسة بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

async function saveLibrarySettings(e) {
    e.preventDefault();
    const data = {
        loan_limit: document.getElementById('loanLimit').value
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المكتبة بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

function submitImport() {
    const input = document.getElementById('importFile');
    if(input.files && input.files[0]) {
        if(!confirm("هل تريد استيراد البيانات من الملف المحدد؟")) return;

        // Since the current import logic is a management command on the server,
        // we can either invoke it via a view or do client-side parsing.
        // The original `import_eleve_view` invokes the command.

        // We will construct a FormData to send the file to `import_eleve_view`
        // But `import_eleve_view` in `ui_views.py` expects a file named 'Eleve.xls' on disk currently.
        // It should be updated to handle uploaded files.
        // For now, let's just trigger the form submit to the view.

        // Create a temporary form to submit to the existing view
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'import_eleve_view' %}";
        form.enctype = 'multipart/form-data'; // Important!

        // Add CSRF
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = getCookie('csrftoken');
        form.appendChild(csrf);

        // Add file input - clone it
        const fileClone = input.cloneNode(true);
        fileClone.name = 'eleve_file'; // View needs to be updated to accept this
        form.appendChild(fileClone);

        // Add checkbox value
        if (document.getElementById('updateExisting').checked) {
            const updateInput = document.createElement('input');
            updateInput.type = 'hidden';
            updateInput.name = 'update_existing';
            updateInput.value = 'on';
            form.appendChild(updateInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// User Management Logic
async function loadUsers() {
    if (sessionStorage.getItem('user_role') !== 'director') return;
    document.getElementById('userManagementSection').style.display = 'block';

    try {
        const response = await fetch('/canteen/api/users/');
        if (!response.ok) return;

        const users = await response.json();
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="western-nums" style="direction:ltr; text-align:left;">${u.username}</td>
                <td>${u.role_display}</td>
                <td>
                    ${u.is_locked ? '<span style="color:red; font-weight:bold;">مقفل</span>' : '<span style="color:green;">نشط</span>'}
                </td>
                <td class="western-nums">${u.failed_attempts}</td>
                <td>
                    <button class="btn btn-info" onclick='editUser(${JSON.stringify(u).replace(/'/g, "&#39;")})' style="padding:5px 10px;"><i class="fas fa-edit"></i></button>
                    ${u.is_locked ? `<button class="btn btn-success" onclick="unlockUser(${u.id})" style="padding:5px 10px;" title="فك القفل"><i class="fas fa-lock-open"></i></button>` : ''}
                    <button class="btn btn-warning" onclick="resetSession(${u.id})" style="padding:5px 10px;" title="إعادة ضبط الجلسة"><i class="fas fa-sync-alt"></i></button>
                    ${u.role !== 'director' ? `<button class="btn btn-danger" onclick="deleteUser(${u.id})" style="padding:5px 10px;" title="حذف"><i class="fas fa-trash"></i></button>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error(e);
    }
}

function openAddUserModal() {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'إضافة مستخدم';
    document.getElementById('userForm').reset();
    document.getElementById('editUserId').value = '';
    document.getElementById('pwdHint').style.display = 'none';
    document.getElementById('uPassword').required = true;
    document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
}

function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

function editUser(user) {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'تعديل مستخدم';
    document.getElementById('editUserId').value = user.id;
    document.getElementById('uUsername').value = user.username;
    document.getElementById('uRole').value = user.role;
    document.getElementById('uPassword').value = '';
    document.getElementById('uPassword').required = false;
    document.getElementById('pwdHint').style.display = 'block';

    // Populate permissions
    document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
    if (user.permissions && Array.isArray(user.permissions)) {
        user.permissions.forEach(p => {
             const chk = document.querySelector(`.perm-check[value="${p}"]`);
             if(chk) chk.checked = true;
        });
    }
}

document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editUserId').value;
    const username = document.getElementById('uUsername').value;
    const password = document.getElementById('uPassword').value;
    const role = document.getElementById('uRole').value;

    // Collect permissions
    const permissions = [];
    document.querySelectorAll('.perm-check:checked').forEach(c => permissions.push(c.value));

    const url = id ? `/canteen/api/users/${id}/update_creds/` : '/canteen/api/users/';

    const body = { username, role, permissions };
    if (password) body.password = password;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(body)
        });

        if (response.ok) {
            alert(id ? "تم التعديل" : "تمت الإضافة");
            closeUserModal();
            loadUsers();
        } else {
            const err = await response.json();
            alert("خطأ: " + (err.error || JSON.stringify(err)));
        }
    } catch (e) {
        alert("خطأ في الاتصال");
    }
});

async function deleteUser(id) {
    if(!confirm("هل أنت متأكد من حذف هذا المستخدم نهائياً؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (response.ok) {
            alert("تم الحذف بنجاح");
            loadUsers();
        } else {
             const err = await response.json();
             alert("خطأ: " + (err.error || "تعذر الحذف"));
        }
    } catch(e) { alert("خطأ في الاتصال"); }
}

async function unlockUser(id) {
    if(!confirm("هل أنت متأكد من فك قفل هذا الحساب؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/unlock_account/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (response.ok) {
            alert("تم فك القفل");
            loadUsers();
        }
    } catch(e) { alert("خطأ"); }
}

async function resetSession(id) {
    if(!confirm("هل أنت متأكد من إعادة ضبط جلسة هذا المستخدم؟ سيتم تسجيل خروجه من جميع الأجهزة.")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/reset_session/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (response.ok) {
            alert("تم إعادة ضبط الجلسة");
        }
    } catch(e) { alert("خطأ"); }
}

async function openLogsModal() {
    document.getElementById('logsModal').style.display = 'flex';
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '<tr><td colspan="3">جاري التحميل...</td></tr>';

    try {
        const res = await fetch('/canteen/api/users/logs/');
        const data = await res.json();
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">السجل فارغ</td></tr>';
            return;
        }

        data.forEach(log => {
            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px; direction:ltr; text-align:left;">${log.username}</td>
                    <td style="padding:8px;">
                        ${log.action === 'login' ? '<span style="color:green">دخول</span>' : '<span style="color:red">خروج</span>'}
                    </td>
                    <td style="padding:8px; direction:ltr;">${new Date(log.timestamp).toLocaleString()}</td>
                </tr>
            `;
        });
    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="3" style="color:red;">خطأ في التحميل</td></tr>';
    }
}

async function clearLogs() {
    if(!confirm('هل أنت متأكد من محو جميع السجلات؟')) return;
    try {
        const res = await fetch('/canteen/api/users/clear_logs/', {
            method: 'POST',
             headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if(res.ok) {
            alert('تم محو السجلات');
            openLogsModal();
        }
    } catch(e) { alert('خطأ'); }
}
</script>
{% endblock %}
