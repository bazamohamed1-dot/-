{% extends 'base.html' %}
{% load static %}

{% block title %}الإعدادات والصلاحيات{% endblock %}
{% block header_title %}الإعدادات العامة والصلاحيات{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-school"></i> بيانات المؤسسة</h3>
    <form id="schoolSettingsForm" onsubmit="saveSchoolSettings(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">اسم المؤسسة</label>
                <input type="text" id="schoolName" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">السنة الدراسية</label>
                <input type="text" id="academicYear" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">اسم المدير</label>
                <input type="text" id="directorName" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">بريد المدير (للاستعادة)</label>
                <input type="email" id="adminEmail" class="form-input" style="width:100%; padding:10px; direction:ltr; text-align:left;">
            </div>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ الإعدادات</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-book"></i> إعدادات المكتبة</h3>
    <form id="librarySettingsForm" onsubmit="saveLibrarySettings(event)">
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">الحد الأقصى للإعارات (الافتراضي)</label>
            <input type="number" id="loanLimit" class="form-input western-nums" required style="width:100%; padding:10px; direction: ltr;" min="1" value="2">
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">حدود الإعارة حسب المستوى (اختياري)</label>
            <div id="levelLimitsContainer" style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="newLimitLevel" class="form-input" style="flex:1;">
                        <option value="">اختر المستوى...</option>
                        <!-- Populated via JS -->
                    </select>
                    <input type="number" id="newLimitValue" placeholder="الحد" class="form-input western-nums" style="width:80px;" min="1">
                    <button type="button" class="btn btn-success" onclick="addLevelLimit()"><i class="fas fa-plus"></i></button>
                </div>
                <ul id="levelLimitsList" style="list-style: none; padding: 0;">
                    <!-- Populated via JS -->
                </ul>
            </div>
        </div>

         <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ إعدادات المكتبة</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-utensils"></i> إعدادات المطعم</h3>
    <form id="canteenSettingsForm" onsubmit="saveCanteenSettings(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
             <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">وقت الفتح</label>
                <input type="time" id="canteenOpen" class="form-input western-nums" required style="width:100%; padding:10px; direction: ltr;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">وقت الغلق</label>
                <input type="time" id="canteenClose" class="form-input western-nums" required style="width:100%; padding:10px; direction: ltr;">
            </div>
        </div>
        <div style="margin-top: 15px;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">أيام العمل</label>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <label><input type="checkbox" class="day-check" value="6"> الأحد</label>
                <label><input type="checkbox" class="day-check" value="0"> الاثنين</label>
                <label><input type="checkbox" class="day-check" value="1"> الثلاثاء</label>
                <label><input type="checkbox" class="day-check" value="2"> الأربعاء</label>
                <label><input type="checkbox" class="day-check" value="3"> الخميس</label>
                <label><input type="checkbox" class="day-check" value="4"> الجمعة</label>
                <label><input type="checkbox" class="day-check" value="5"> السبت</label>
            </div>
        </div>
         <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ إعدادات المطعم</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-database"></i> إدارة قاعدة البيانات</h3>
    <form action="{% url 'import_eleve_view' %}" method="post" enctype="multipart/form-data" style="padding: 10px 0;">
        {% csrf_token %}
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
            <label class="btn btn-info" style="background:#0891b2; color:white; cursor:pointer;">
                <i class="fas fa-file-import"></i> اختر ملف Excel
                <input type="file" name="eleve_file" style="display:none;" required onchange="document.getElementById('fileName').textContent = this.files[0].name">
            </label>
            <span id="fileName" style="color:#64748b;">لم يتم اختيار ملف</span>
        </div>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <input type="checkbox" id="updateExisting" name="update_existing" style="width:20px; height:20px;">
            <label for="updateExisting" style="cursor:pointer;">تحديث البيانات الموجودة (إذا وجد الطالب)</label>
        </div>

        <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload"></i> بدء الاستيراد
        </button>

        <p style="margin-top:10px; color:#64748b; font-size:0.9rem;">
            * يدعم ملفات Excel (.xlsx, .xls) و HTML (.xls).
            <br>* العملية قد تستغرق بضع ثوانٍ، يرجى الانتظار حتى تظهر رسالة النجاح.
        </p>
    </form>
</div>


<!-- 2FA Section (Director Only) -->
<div class="card" id="2faSection" style="display:none; margin-bottom: 20px;">
    <h3><i class="fas fa-shield-alt"></i> المصادقة الثنائية</h3>
    <p style="color:#64748b;">قم بحماية حساب المدير باستخدام تطبيق المصادقة (Google Authenticator أو Microsoft Authenticator).</p>

    <div id="2faStatusArea" style="margin-top:15px;">
        <!-- Filled by JS -->
    </div>
</div>

<!-- System Messages Section -->
<div class="card" id="systemMsgSection" style="display:none; margin-bottom: 20px;">
    <h3><i class="fas fa-bullhorn"></i> رسائل النظام</h3>
    <form onsubmit="postSystemMessage(event)" style="margin-top:15px;">
        <div style="margin-bottom: 10px;">
            <label style="font-weight:bold;">المستلم:</label>
            <select id="sysMsgRecipient" class="form-input" style="width:100%; padding:8px;">
                <option value="">جميع المستخدمين (رسالة عامة)</option>
                <!-- Populated via JS -->
            </select>
        </div>
        <textarea id="sysMsgText" class="form-input" placeholder="نص الرسالة..." style="width:100%; height:80px; margin-bottom:10px; padding:10px;" required></textarea>
        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> إرسال</button>
    </form>
</div>

<!-- Role Management Section -->
<div class="card" id="roleManagementSection" style="display:none; margin-bottom: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
        <h3><i class="fas fa-user-tag"></i> إدارة الأدوار المخصصة</h3>
        <button class="btn btn-success" onclick="openRoleModal()"><i class="fas fa-plus"></i> إضافة دور جديد</button>
    </div>
    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr style="background:#f8fafc; text-align:right;">
                <th style="padding:10px;">اسم الدور</th>
                <th style="padding:10px;">عدد الصلاحيات</th>
                <th style="padding:10px;">إجراءات</th>
            </tr>
        </thead>
        <tbody id="rolesTableBody">
            <!-- Populated via JS -->
        </tbody>
    </table>
</div>


<!-- User Management Section -->
<div class="card" id="userManagementSection" style="display:none; margin-bottom: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
        <h3><i class="fas fa-users-cog"></i> إدارة المستخدمين</h3>
        <div style="display:flex; gap:10px;">
             <button class="btn btn-primary" onclick="openLogsModal()"><i class="fas fa-history"></i> سجل الدخول والخروج</button>
             <button class="btn btn-success" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة مستخدم</button>
        </div>
    </div>

    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr style="background:#f8fafc; text-align:right;">
                <th style="padding:10px;">اسم المستخدم</th>
                <th style="padding:10px;">البريد الإلكتروني</th>
                <th style="padding:10px;">الدور</th>
                <th style="padding:10px;">دخول سحابي</th>
                <th style="padding:10px;">حماية الجهاز</th>
                <th style="padding:10px;">إجراءات</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            <!-- Populated via JS -->
        </tbody>
    </table>
</div>

<!-- QR Code Modal -->
<div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; justify-content:center; align-items:center;">
    <div class="card" style="width:300px; padding:20px; text-align:center;">
        <h3 style="margin-bottom:15px;">مسح لتثبيت التطبيق</h3>
        <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">اطلب من الموظف مسح هذا الرمز للدخول وتثبيت التطبيق فوراً.</p>
        <div id="qrImageContainer" style="margin-bottom:15px;"></div>
        <button class="btn btn-secondary" onclick="document.getElementById('qrModal').style.display='none'">إغلاق</button>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div class="card" style="width:400px; padding:20px;">
        <h3 id="userModalTitle" style="margin-bottom:20px;">إضافة مستخدم</h3>
        <form id="userForm">
            <input type="hidden" id="editUserId">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">اسم المستخدم</label>
                <input type="text" id="uUsername" class="form-input western-nums" style="width:100%; padding:10px; direction:ltr; text-align:left;" required>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">البريد الإلكتروني (جوجل)</label>
                <input type="email" id="uEmail" class="form-input western-nums" style="width:100%; padding:10px; direction:ltr; text-align:left;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">كلمة المرور</label>
                <input type="password" id="uPassword" class="form-input western-nums" style="width:100%; padding:10px; direction:ltr; text-align:left;">
                <small style="color:#666; display:none;" id="pwdHint">اتركه فارغاً إذا لم ترد التغيير</small>
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">الدور</label>
                <select id="uRole" class="form-input" style="width:100%; padding:10px;" onchange="onRoleChange()" required>
                    <option value="">اختر...</option>
                    <optgroup label="أدوار النظام">
                        <option value="librarian" data-perms='["access_library","library_scan","library_loan","library_return","library_readers_list"]'>مكتبي</option>
                        <option value="storekeeper" data-perms='["access_canteen","canteen_scan","canteen_manual","canteen_export"]'>مخزني (مطعم)</option>
                        <option value="archivist" data-perms='["access_archive"]'>أرشيفي</option>
                        <option value="secretariat" data-perms='["access_management","student_add","student_edit","student_print","import_data"]'>أمانة</option>
                    </optgroup>
                    <optgroup label="أدوار مخصصة" id="customRolesOptGroup">
                        <!-- Populated via JS -->
                    </optgroup>
                </select>
            </div>

            <div style="margin-bottom:15px; border-top:1px solid #eee; padding-top:10px;">
                <label style="display:block; margin-bottom:10px; font-weight:bold;">الصلاحيات التفصيلية</label>

                <div style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-utensils"></i> المطعم</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_canteen" id="perm_canteen_access"> <label for="perm_canteen_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_scan" id="perm_canteen_scan"> <label for="perm_canteen_scan">مسح البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_manual" id="perm_canteen_manual"> <label for="perm_canteen_manual">إدخال يدوي</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_export" id="perm_canteen_export"> <label for="perm_canteen_export">تصدير القوائم</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-book"></i> المكتبة</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_library" id="perm_lib_access"> <label for="perm_lib_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_scan" id="perm_lib_scan"> <label for="perm_lib_scan">مسح البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_loan" id="perm_lib_loan"> <label for="perm_lib_loan">إعارة الكتب</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_return" id="perm_lib_return"> <label for="perm_lib_return">إرجاع الكتب</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_readers_list" id="perm_lib_readers"> <label for="perm_lib_readers">قائمة القراء (حذف)</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-user-graduate"></i> التلاميذ</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_management" id="perm_std_access"> <label for="perm_std_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_add" id="perm_std_add"> <label for="perm_std_add">إضافة تلميذ</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_edit" id="perm_std_edit"> <label for="perm_std_edit">تعديل بيانات</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_delete" id="perm_std_del"> <label for="perm_std_del">حذف تلاميذ</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_print" id="perm_std_print"> <label for="perm_std_print">طباعة البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="import_data" id="perm_std_import"> <label for="perm_std_import">استيراد البيانات</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-cog"></i> الإدارة</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="manage_users" id="perm_adm_users"> <label for="perm_adm_users">إدارة المستخدمين</label></div>
                             <div><input type="checkbox" class="perm-check" value="manage_settings" id="perm_adm_settings"> <label for="perm_adm_settings">الإعدادات العامة</label></div>
                             <div><input type="checkbox" class="perm-check" value="access_archive" id="perm_archive"> <label for="perm_archive">الأرشيف</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="submit" class="btn btn-primary" style="flex:1;">حفظ</button>
                <button type="button" class="btn btn-danger" onclick="closeUserModal()" style="flex:1;">إلغاء</button>
            </div>
        </form>
    </div>
</div>

<!-- Logs Modal -->
<div id="logsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div class="card" style="width:600px; padding:20px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
             <h3 style="margin:0;">سجل نشاط المستخدمين</h3>
             <button class="btn btn-danger" onclick="clearLogs()"><i class="fas fa-trash"></i> محو السجل</button>
        </div>
        <table style="width:100%; border-collapse: collapse;">
             <thead>
                 <tr style="background:#f1f5f9; text-align:right;">
                     <th style="padding:8px;">المستخدم</th>
                     <th style="padding:8px;">النشاط</th>
                     <th style="padding:8px;">التوقيت</th>
                 </tr>
             </thead>
             <tbody id="logsTableBody">
                 <tr><td colspan="3">جاري التحميل...</td></tr>
             </tbody>
        </table>
        <div style="text-align:center; margin-top:20px;">
             <button class="btn btn-secondary" onclick="document.getElementById('logsModal').style.display='none'">إغلاق</button>
        </div>
    </div>
</div>

<!-- Role Modal -->
<div id="roleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div class="card" style="width:400px; padding:20px;">
        <h3 style="margin-bottom:20px;">إضافة دور جديد</h3>
        <form onsubmit="saveRole(event)">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">اسم الدور</label>
                <input type="text" id="roleName" class="form-input" required style="width:100%; padding:10px;">
            </div>

            <div style="margin-bottom:15px; border-top:1px solid #eee; padding-top:10px;">
                <label style="display:block; margin-bottom:10px; font-weight:bold;">الصلاحيات</label>
                <div style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" id="rolePermsContainer">
                    <!-- Cloned from user modal logic via JS -->
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="submit" class="btn btn-primary" style="flex:1;">حفظ</button>
                <button type="button" class="btn btn-danger" onclick="document.getElementById('roleModal').style.display='none'" style="flex:1;">إلغاء</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    loadUsers();
    loadRoles(); // Load roles
    check2FA();
    loadLevelsForDropdown(); // Load Levels
});

async function loadLevelsForDropdown() {
    try {
        const response = await fetch('/canteen/api/students/filters/');
        const data = await response.json();
        const select = document.getElementById('newLimitLevel');
        if (data.levels && Array.isArray(data.levels)) {
            data.levels.forEach(lvl => {
                const opt = document.createElement('option');
                opt.value = lvl;
                opt.textContent = lvl;
                select.appendChild(opt);
            });
        }
    } catch (e) { console.error("Failed to load levels", e); }
}

let levelLimits = {};

async function loadSettings() {
    try {
        const response = await fetch('/canteen/settings/data/');
        const data = await response.json();

        if (data.name) document.getElementById('schoolName').value = data.name;
        if (data.academic_year) document.getElementById('academicYear').value = data.academic_year;
        if (data.director_name) document.getElementById('directorName').value = data.director_name;
        if (data.loan_limit) document.getElementById('loanLimit').value = data.loan_limit;
        if (data.admin_email) document.getElementById('adminEmail').value = data.admin_email;

        // Library Level Limits
        if (data.loan_limits_by_level) {
            levelLimits = data.loan_limits_by_level;
            renderLevelLimits();
        }

        // Canteen
        if (data.canteen_open_time) document.getElementById('canteenOpen').value = data.canteen_open_time.substring(0,5);
        if (data.canteen_close_time) document.getElementById('canteenClose').value = data.canteen_close_time.substring(0,5);
        if (data.canteen_days) {
            const days = data.canteen_days.split(',');
            document.querySelectorAll('.day-check').forEach(chk => {
                chk.checked = days.includes(chk.value);
            });
        }
    } catch (error) {
        console.error("Error loading settings", error);
    }
}

function renderLevelLimits() {
    const list = document.getElementById('levelLimitsList');
    list.innerHTML = '';
    for (const [level, limit] of Object.entries(levelLimits)) {
        const li = document.createElement('li');
        li.style.marginBottom = '5px';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.background = 'white';
        li.style.padding = '8px';
        li.style.borderRadius = '4px';
        li.innerHTML = `
            <span><strong>${level}</strong>: ${limit} كتب</span>
            <button type="button" class="btn btn-danger" style="padding:2px 6px;" onclick="removeLevelLimit('${level}')"><i class="fas fa-trash"></i></button>
        `;
        list.appendChild(li);
    }
}

function addLevelLimit() {
    const level = document.getElementById('newLimitLevel').value.trim();
    const limit = document.getElementById('newLimitValue').value;

    if(!level || !limit) return alert("أدخل المستوى والحد");

    levelLimits[level] = parseInt(limit);
    document.getElementById('newLimitLevel').value = '';
    document.getElementById('newLimitValue').value = '';
    renderLevelLimits();
}

function removeLevelLimit(level) {
    delete levelLimits[level];
    renderLevelLimits();
}

async function saveSchoolSettings(e) {
    e.preventDefault();
    const data = {
        name: document.getElementById('schoolName').value,
        academic_year: document.getElementById('academicYear').value,
        director_name: document.getElementById('directorName').value,
        admin_email: document.getElementById('adminEmail').value
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('baza_school_csrf_v2')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المؤسسة بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

async function saveCanteenSettings(e) {
    e.preventDefault();
    const days = [];
    document.querySelectorAll('.day-check:checked').forEach(c => days.push(c.value));

    const data = {
        canteen_open_time: document.getElementById('canteenOpen').value,
        canteen_close_time: document.getElementById('canteenClose').value,
        canteen_days: days.join(',')
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('baza_school_csrf_v2')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المطعم بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

async function saveLibrarySettings(e) {
    e.preventDefault();
    const data = {
        loan_limit: document.getElementById('loanLimit').value,
        loan_limits_by_level: levelLimits
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('baza_school_csrf_v2')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المكتبة بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Role Management Logic
let customRoles = [];

async function loadRoles() {
    if (sessionStorage.getItem('user_role') !== 'director') return;
    document.getElementById('roleManagementSection').style.display = 'block';

    try {
        const res = await fetch('/canteen/api/roles/');
        if (!res.ok) return; // Handle error or non-200
        const data = await res.json();

        // Ensure data is an array
        customRoles = Array.isArray(data) ? data : (data.results || []);

        const tbody = document.getElementById('rolesTableBody');
        tbody.innerHTML = '';
        const optGroup = document.getElementById('customRolesOptGroup');
        optGroup.innerHTML = '';

        customRoles.forEach(r => {
            // Table Row
            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #eee;">
                    <td>${r.name}</td>
                    <td class="western-nums">${r.permissions.length}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRole(${r.id})" style="padding:5px 10px;"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;

            // Dropdown Option
            const opt = document.createElement('option');
            opt.value = r.name;
            opt.textContent = r.name;
            // Store perms as data attribute
            opt.setAttribute('data-perms', JSON.stringify(r.permissions));
            optGroup.appendChild(opt);
        });
    } catch(e) { console.error(e); }
}

async function saveRole(e) {
    e.preventDefault();
    const name = document.getElementById('roleName').value;
    const perms = [];
    document.querySelectorAll('#roleModal .perm-check:checked').forEach(c => perms.push(c.value));

    try {
        const res = await fetch('/canteen/api/roles/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('baza_school_csrf_v2')},
            body: JSON.stringify({ name: name, permissions: perms })
        });
        if(res.ok) {
            alert("تم حفظ الدور");
            document.getElementById('roleModal').style.display = 'none';
            loadRoles();
        } else {
            alert("خطأ (ربما الاسم مكرر)");
        }
    } catch(e) { alert("Error"); }
}

async function deleteRole(id) {
    if(!confirm("حذف هذا الدور؟ لن يؤثر على المستخدمين الحاليين.")) return;
    try {
        const res = await fetch(`/canteen/api/roles/${id}/`, {
            method: 'DELETE',
            headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if(res.ok) loadRoles();
    } catch(e) { alert("Error"); }
}

function openRoleModal() {
    document.getElementById('roleModal').style.display = 'flex';
    document.getElementById('roleName').value = '';
    // Clone permissions from User Modal to Role Modal if empty
    const source = document.querySelector('#userModal .max-height-200, #userModal div[style*="max-height: 200px"]');
    const target = document.getElementById('rolePermsContainer');
    if(source && target.innerHTML.trim() === '') {
        target.innerHTML = source.innerHTML;
        // Ensure IDs are unique to avoid conflict
        target.querySelectorAll('input').forEach(inp => {
            inp.id = 'role_' + inp.id;
            inp.nextElementSibling.setAttribute('for', inp.id);
        });
    }
    // Uncheck all
    target.querySelectorAll('input').forEach(i => i.checked = false);
}

function onRoleChange() {
    const select = document.getElementById('uRole');
    const selectedOpt = select.options[select.selectedIndex];
    const permsData = selectedOpt.getAttribute('data-perms');

    if (permsData) {
        const perms = JSON.parse(permsData);
        // Uncheck all first
        document.querySelectorAll('#userModal .perm-check').forEach(c => c.checked = false);
        // Check matching
        perms.forEach(p => {
            const chk = document.querySelector(`#userModal .perm-check[value="${p}"]`);
            if(chk) chk.checked = true;
        });
    }
}

// User Management Logic
async function loadUsers() {
    // Ensure this runs for Director/Superuser
    const section = document.getElementById('userManagementSection');
    if(section) section.style.display = 'block';
    const msgSection = document.getElementById('systemMsgSection');
    if(msgSection) msgSection.style.display = 'block';

    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">جاري التحميل...</td></tr>';

    try {
        // Fetch all users
        const response = await fetch('/canteen/api/users/');
        if (!response.ok) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">فشل تحميل المستخدمين</td></tr>';
            return;
        }

        let users = await response.json();
        // If paginated, get results
        if (users.results && Array.isArray(users.results)) users = users.results;

        tbody.innerHTML = '';
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">لا يوجد مستخدمين مسجلين</td></tr>';
            return;
        }

        // Populate Message Dropdown
        const msgSelect = document.getElementById('sysMsgRecipient');
        msgSelect.innerHTML = '<option value="">جميع المستخدمين (رسالة عامة)</option>';

        users.forEach(u => {
            // Add to dropdown
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = `${u.username} (${u.role_display})`;
            msgSelect.appendChild(opt);

            const tr = document.createElement('tr');
            let deviceBtn = '';
            if (u.device_status === 'مفعل') {
                deviceBtn = `<button class="btn btn-danger" onclick="resetDevice(${u.id})" style="padding:5px 10px;" title="تعطيل حماية الجهاز"><i class="fas fa-mobile-alt"></i> تعطيل</button>`;
            } else if (u.device_status === 'بانتظار التفعيل') {
                deviceBtn = `<span style="color:orange; font-size:0.8em">بانتظار الدخول...</span> <button class="btn btn-warning" onclick="resetDevice(${u.id})" style="padding:2px 5px;"><i class="fas fa-times"></i></button>`;
            } else {
                deviceBtn = `<button class="btn btn-success" onclick="activateDevice(${u.id})" style="padding:5px 10px;" title="تفعيل حماية الجهاز"><i class="fas fa-mobile-alt"></i> تفعيل</button>`;
            }

            const lastLogin = u.last_login ? new Date(u.last_login).toLocaleString('en-GB') : '-';
            const lastActive = u.last_activity ? new Date(u.last_activity).toLocaleTimeString('en-GB') : '-';
            const onlineDot = u.is_online
                ? '<i class="fas fa-circle" style="color:#10b981; font-size:0.8rem;"></i> متصل'
                : '<i class="fas fa-circle" style="color:#cbd5e1; font-size:0.8rem;"></i> غير متصل';

            tr.innerHTML = `
                <td class="western-nums" style="direction:ltr; text-align:left;">
                    ${u.username}
                    ${u.is_locked ? '<span style="color:red; font-size:0.8rem; margin-left:5px;">(مقفل)</span>' : ''}
                </td>
                <td class="western-nums" style="direction:ltr; text-align:left;">${u.email || '-'}</td>
                <td>${u.role_display}</td>
                <td>${deviceBtn}</td>
                <td>
                    <button class="btn btn-info" onclick='editUser(${JSON.stringify(u).replace(/'/g, "&#39;")})' style="padding:5px 10px;" title="تعديل"><i class="fas fa-edit"></i></button>
                    <button class="btn" style="padding:5px 10px; background:#0f172a; color:white;" onclick="showUserQR('${u.username}')" title="رمز الدخول (QR)"><i class="fas fa-qrcode"></i></button>
                    <button class="btn btn-secondary" onclick="prefillMessage(${u.id}, '${u.username}')" style="padding:5px 10px; background:#475569; color:white;" title="إرسال رسالة"><i class="fas fa-envelope"></i></button>
                    ${u.is_locked ? `<button class="btn btn-success" onclick="unlockUser(${u.id})" style="padding:5px 10px;" title="فك القفل"><i class="fas fa-lock-open"></i></button>` : ''}
                    <button class="btn btn-warning" onclick="resetSession(${u.id})" style="padding:5px 10px;" title="إعادة ضبط الجلسة"><i class="fas fa-sync-alt"></i></button>
                    ${u.role !== 'director' ? `<button class="btn btn-danger" onclick="deleteUser(${u.id})" style="padding:5px 10px;" title="حذف"><i class="fas fa-trash"></i></button>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error(e);
    }
}

async function activateDevice(id) {
    if(!confirm("هل أنت متأكد من تفعيل حماية الجهاز لهذا المستخدم؟ سيتم ربط أول جهاز يقوم بتسجيل الدخول.")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/activate_device/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if (response.ok) {
            alert("تم التفعيل. سيتم الربط عند الدخول القادم.");
            loadUsers();
        }
    } catch(e) { alert("خطأ"); }
}

async function resetDevice(id) {
    if(!confirm("هل أنت متأكد من تعطيل/إعادة ضبط حماية الجهاز؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/reset_device/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if (response.ok) {
            alert("تم تعطيل الحماية.");
            loadUsers();
        }
    } catch(e) { alert("خطأ"); }
}


function prefillMessage(userId, username) {
    document.getElementById('sysMsgRecipient').value = userId;
    document.getElementById('sysMsgSection').scrollIntoView({behavior: 'smooth'});
    document.getElementById('sysMsgText').focus();
    document.getElementById('sysMsgText').placeholder = `رسالة خاصة إلى ${username}...`;
}

async function postSystemMessage(e) {
    e.preventDefault();
    const msg = document.getElementById('sysMsgText').value;
    const recipient = document.getElementById('sysMsgRecipient').value || null;

    try {
        const res = await fetch('/canteen/api/system_messages/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('baza_school_csrf_v2')
            },
            body: JSON.stringify({ message: msg, recipient: recipient, active: true })
        });
        if(res.ok) {
            alert("تم إرسال الرسالة");
            document.getElementById('sysMsgText').value = '';
            document.getElementById('sysMsgRecipient').value = "";
            document.getElementById('sysMsgText').placeholder = "نص الرسالة...";
        }
    } catch(e) { alert("خطأ"); }
}

function openAddUserModal() {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'إضافة مستخدم';
    document.getElementById('userForm').reset();
    document.getElementById('editUserId').value = '';
    document.getElementById('pwdHint').style.display = 'none';
    document.getElementById('uPassword').required = true;
    document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
}

function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

function editUser(user) {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'تعديل مستخدم';
    document.getElementById('editUserId').value = user.id;
    document.getElementById('uUsername').value = user.username;
    document.getElementById('uRole').value = user.role;
    document.getElementById('uEmail').value = user.email || '';
    document.getElementById('uPassword').value = '';
    document.getElementById('uPassword').required = false;
    document.getElementById('pwdHint').style.display = 'block';

    // Populate permissions
    document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
    if (user.permissions && Array.isArray(user.permissions)) {
        user.permissions.forEach(p => {
             const chk = document.querySelector(`.perm-check[value="${p}"]`);
             if(chk) chk.checked = true;
        });
    }
}

document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editUserId').value;
    const username = document.getElementById('uUsername').value;
    const password = document.getElementById('uPassword').value;
    const role = document.getElementById('uRole').value;
    const email = document.getElementById('uEmail').value;

    // Collect permissions
    const permissions = [];
    document.querySelectorAll('.perm-check:checked').forEach(c => permissions.push(c.value));

    const url = id ? `/canteen/api/users/${id}/update_creds/` : '/canteen/api/users/';

    const body = {
        username, role, permissions, email
    };

    if (password) body.password = password;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('baza_school_csrf_v2')
            },
            body: JSON.stringify(body)
        });

        if (response.ok) {
            alert(id ? "تم التعديل" : "تمت الإضافة");
            closeUserModal();
            loadUsers();
        } else {
            const err = await response.json();
            alert("خطأ: " + (err.error || JSON.stringify(err)));
        }
    } catch (e) {
        alert("خطأ في الاتصال");
    }
});

async function deleteUser(id) {
    if(!confirm("هل أنت متأكد من حذف هذا المستخدم نهائياً؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('baza_school_csrf_v2')
            }
        });

        if (response.ok) {
            alert("تم الحذف بنجاح");
            loadUsers();
        } else {
             const err = await response.json();
             alert("خطأ: " + (err.error || "تعذر الحذف"));
        }
    } catch(e) { alert("خطأ في الاتصال"); }
}

async function unlockUser(id) {
    if(!confirm("هل أنت متأكد من فك قفل هذا الحساب؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/unlock_account/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if (response.ok) {
            alert("تم فك القفل");
            loadUsers();
        }
    } catch(e) { alert("خطأ"); }
}

async function resetSession(id) {
    if(!confirm("هل أنت متأكد من إعادة ضبط جلسة هذا المستخدم؟ سيتم تسجيل خروجه من جميع الأجهزة.")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/reset_session/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if (response.ok) {
            alert("تم إعادة ضبط الجلسة");
        }
    } catch(e) { alert("خطأ"); }
}

async function openLogsModal() {
    document.getElementById('logsModal').style.display = 'flex';
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '<tr><td colspan="3">جاري التحميل...</td></tr>';

    try {
        const res = await fetch('/canteen/api/users/logs/');
        const data = await res.json();
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">السجل فارغ</td></tr>';
            return;
        }

        data.forEach(log => {
            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px; direction:ltr; text-align:left;">${log.username}</td>
                    <td style="padding:8px;">
                        ${log.action === 'login' ? '<span style="color:green">دخول</span>' : '<span style="color:red">خروج</span>'}
                    </td>
                    <td style="padding:8px; direction:ltr;">${new Date(log.timestamp).toLocaleString()}</td>
                </tr>
            `;
        });
    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="3" style="color:red;">خطأ في التحميل</td></tr>';
    }
}

async function clearLogs() {
    if(!confirm('هل أنت متأكد من محو جميع السجلات؟')) return;
    try {
        const res = await fetch('/canteen/api/users/clear_logs/', {
            method: 'POST',
             headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if(res.ok) {
            alert('تم محو السجلات');
            openLogsModal();
        }
    } catch(e) { alert('خطأ'); }
}

// 2FA Logic
async function check2FA() {
    if (sessionStorage.getItem('user_role') !== 'director') return;
    document.getElementById('2faSection').style.display = 'block';

    // We can't check status easily without API, let's assume if role is director we show the section.
    // Ideally we fetch current status. For now, simple "Setup" button.
    render2FAInitial();
}

function render2FAInitial() {
    const area = document.getElementById('2faStatusArea');
    area.innerHTML = `
        <button class="btn btn-info" onclick="setup2FA()"><i class="fas fa-qrcode"></i> إعداد / إعادة ضبط المصادقة</button>
        <button class="btn btn-danger" onclick="disable2FA()"><i class="fas fa-ban"></i> تعطيل المصادقة</button>
    `;
}

async function setup2FA() {
    try {
        const res = await fetch('/canteen/auth/2fa/setup/', {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();

        const area = document.getElementById('2faStatusArea');
        area.innerHTML = `
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; text-align:center;">
                <p>امسح الرمز التالي بتطبيق المصادقة:</p>
                <img src="${data.qr_code}" style="width:150px; height:150px; border:1px solid #ddd; padding:5px; background:white;">
                <p style="margin-top:10px; font-family:monospace; direction:ltr;">Secret: ${data.secret}</p>

                <div style="margin-top:15px; max-width:300px; margin-left:auto; margin-right:auto;">
                    <input type="text" id="verify2fa" class="form-input western-nums" placeholder="أدخل الرمز (6 أرقام)" style="text-align:center; font-size:1.2rem; letter-spacing:3px;" maxlength="6">
                    <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="confirm2FA()">تأكيد وتفعيل</button>
                    <button class="btn" style="width:100%; margin-top:5px; background:#ddd;" onclick="render2FAInitial()">إلغاء</button>
                </div>
            </div>
        `;
    } catch(e) { alert("Error setting up 2FA"); }
}

async function confirm2FA() {
    const code = document.getElementById('verify2fa').value;
    if(!code) return alert("أدخل الرمز");

    try {
        const res = await fetch('/canteen/auth/2fa/confirm/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('baza_school_csrf_v2')
            },
            body: JSON.stringify({ code: code })
        });

        if (res.ok) {
            alert("تم تفعيل المصادقة الثنائية بنجاح!");
            render2FAInitial();
        } else {
            alert("الرمز غير صحيح");
        }
    } catch(e) { alert("Error"); }
}

async function disable2FA() {
    if(!confirm("هل أنت متأكد من تعطيل المصادقة الثنائية؟ سيقلل هذا من أمان الحساب.")) return;
    try {
        const res = await fetch('/canteen/auth/2fa/disable/', {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('baza_school_csrf_v2')}
        });
        if(res.ok) alert("تم التعطيل");
    } catch(e) { alert("Error"); }
}

async function showUserQR(username) {
    try {
        const res = await fetch(`/canteen/api/generate_qr/?username=${encodeURIComponent(username)}`);
        if(!res.ok) throw new Error("Failed");
        const data = await res.json();

        document.getElementById('qrImageContainer').innerHTML = `<img src="${data.qr_code}" style="width:200px; height:200px;">`;
        document.getElementById('qrModal').style.display = 'flex';
    } catch(e) {
        alert("فشل توليد الرمز");
    }
}
</script>
{% endblock %}
