{% extends 'base.html' %}
{% load static %}

{% block title %}الإعدادات والصلاحيات{% endblock %}
{% block header_title %}الإعدادات العامة والصلاحيات{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-school"></i> بيانات المؤسسة</h3>
    <form id="schoolSettingsForm" onsubmit="saveSchoolSettings(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">اسم المؤسسة</label>
                <input type="text" id="schoolName" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">السنة الدراسية</label>
                <input type="text" id="academicYear" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">اسم المدير</label>
                <input type="text" id="directorName" class="form-input" required style="width:100%; padding:10px;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">بريد المدير (للاستعادة)</label>
                <input type="email" id="adminEmail" class="form-input" style="width:100%; padding:10px; direction:ltr; text-align:left;">
            </div>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ الإعدادات</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-book"></i> إعدادات المكتبة</h3>
    <form id="librarySettingsForm" onsubmit="saveLibrarySettings(event)">
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
             <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">الحد الأقصى للإعارات</label>
                <input type="number" id="loanLimit" class="form-input western-nums" required style="width:100%; padding:10px; direction: ltr;" min="1" value="2">
            </div>
        </div>
         <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ إعدادات المكتبة</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-utensils"></i> إعدادات المطعم</h3>
    <form id="canteenSettingsForm" onsubmit="saveCanteenSettings(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
             <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">وقت الفتح</label>
                <input type="time" id="canteenOpen" class="form-input western-nums" required style="width:100%; padding:10px; direction: ltr;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px; font-weight:bold;">وقت الغلق</label>
                <input type="time" id="canteenClose" class="form-input western-nums" required style="width:100%; padding:10px; direction: ltr;">
            </div>
        </div>
        <div style="margin-top: 15px;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">أيام العمل</label>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <label><input type="checkbox" class="day-check" value="6"> الأحد</label>
                <label><input type="checkbox" class="day-check" value="0"> الاثنين</label>
                <label><input type="checkbox" class="day-check" value="1"> الثلاثاء</label>
                <label><input type="checkbox" class="day-check" value="2"> الأربعاء</label>
                <label><input type="checkbox" class="day-check" value="3"> الخميس</label>
                <label><input type="checkbox" class="day-check" value="4"> الجمعة</label>
                <label><input type="checkbox" class="day-check" value="5"> السبت</label>
            </div>
        </div>
         <button type="submit" class="btn btn-primary" style="margin-top: 15px;">حفظ إعدادات المطعم</button>
    </form>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3><i class="fas fa-database"></i> إدارة قاعدة البيانات</h3>
    <div style="padding: 10px 0;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="btn btn-info" style="background:#0891b2; color:white" onclick="document.getElementById('importFile').click()">
                <i class="fas fa-file-import"></i> استيراد التلاميذ من ملف Excel
            </button>
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="updateExisting" name="update_existing" style="width:20px; height:20px;">
                <label for="updateExisting" style="margin-right:8px; cursor:pointer;">تحديث البيانات الموجودة</label>
            </div>
        </div>
        <input type="file" id="importFile" style="display:none;" onchange="handleFileSelect(this)">
        <p style="margin-top:10px; color:#64748b; font-size:0.9rem;">
            * سيتم قراءة الملف محلياً لتفادي أخطاء السيرفر (يدعم .xls و .html).
        </p>
        <div id="uploadProgress" style="display:none; margin-top:15px; padding:10px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px; color:#0369a1;">
            <i class="fas fa-spinner fa-spin"></i> جاري استيراد البيانات... <span id="progressText">0%</span>
        </div>
    </div>
</div>


<!-- 2FA Section (Director Only) -->
<div class="card" id="2faSection" style="display:none; margin-bottom: 20px;">
    <h3><i class="fas fa-shield-alt"></i> المصادقة الثنائية</h3>
    <p style="color:#64748b;">قم بحماية حساب المدير باستخدام تطبيق المصادقة (Google Authenticator أو Microsoft Authenticator).</p>

    <div id="2faStatusArea" style="margin-top:15px;">
        <!-- Filled by JS -->
    </div>
</div>

<!-- System Messages Section -->
<div class="card" id="systemMsgSection" style="display:none; margin-bottom: 20px;">
    <h3><i class="fas fa-bullhorn"></i> رسائل النظام</h3>
    <form onsubmit="postSystemMessage(event)" style="margin-top:15px;">
        <textarea id="sysMsgText" class="form-input" placeholder="اكتب رسالة تظهر لجميع المستخدمين..." style="width:100%; height:80px; margin-bottom:10px; padding:10px;" required></textarea>
        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> نشر الرسالة</button>
    </form>
</div>

<!-- User Management Section -->
<div class="card" id="userManagementSection" style="display:none; margin-bottom: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
        <h3><i class="fas fa-users-cog"></i> إدارة المستخدمين</h3>
        <div style="display:flex; gap:10px;">
             <button class="btn btn-primary" onclick="openLogsModal()"><i class="fas fa-history"></i> سجل الدخول والخروج</button>
             <button class="btn btn-success" onclick="openAddUserModal()"><i class="fas fa-plus"></i> إضافة مستخدم</button>
        </div>
    </div>

    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr style="background:#f8fafc; text-align:right;">
                <th style="padding:10px;">اسم المستخدم</th>
                <th style="padding:10px;">الدور</th>
                <th style="padding:10px;">الحالة</th>
                <th style="padding:10px;">حماية الجهاز</th>
                <th style="padding:10px;">المحاولات</th>
                <th style="padding:10px;">إجراءات</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            <!-- Populated via JS -->
        </tbody>
    </table>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div class="card" style="width:400px; padding:20px;">
        <h3 id="userModalTitle" style="margin-bottom:20px;">إضافة مستخدم</h3>
        <form id="userForm">
            <input type="hidden" id="editUserId">
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">اسم المستخدم</label>
                <input type="text" id="uUsername" class="form-input western-nums" style="width:100%; padding:10px; direction:ltr; text-align:left;" required>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">كلمة المرور</label>
                <input type="password" id="uPassword" class="form-input western-nums" style="width:100%; padding:10px; direction:ltr; text-align:left;">
                <small style="color:#666; display:none;" id="pwdHint">اتركه فارغاً إذا لم ترد التغيير</small>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px;">الدور</label>
                <select id="uRole" class="form-input" style="width:100%; padding:10px;" required>
                    <option value="librarian">مكتبي</option>
                    <option value="storekeeper">مخزني (مطعم)</option>
                    <option value="archivist">أرشيفي</option>
                    <option value="secretariat">أمانة</option>
                    <!-- Director option removed to prevent multiple directors -->
                </select>
            </div>

            <div style="margin-bottom:15px; border-top:1px solid #eee; padding-top:10px;">
                <label style="display:block; margin-bottom:10px; font-weight:bold;">الصلاحيات التفصيلية</label>

                <div style="max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-utensils"></i> المطعم</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_canteen" id="perm_canteen_access"> <label for="perm_canteen_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_scan" id="perm_canteen_scan"> <label for="perm_canteen_scan">مسح البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_manual" id="perm_canteen_manual"> <label for="perm_canteen_manual">إدخال يدوي</label></div>
                             <div><input type="checkbox" class="perm-check" value="canteen_export" id="perm_canteen_export"> <label for="perm_canteen_export">تصدير القوائم</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-book"></i> المكتبة</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_library" id="perm_lib_access"> <label for="perm_lib_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_scan" id="perm_lib_scan"> <label for="perm_lib_scan">مسح البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_loan" id="perm_lib_loan"> <label for="perm_lib_loan">إعارة الكتب</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_return" id="perm_lib_return"> <label for="perm_lib_return">إرجاع الكتب</label></div>
                             <div><input type="checkbox" class="perm-check" value="library_readers_list" id="perm_lib_readers"> <label for="perm_lib_readers">قائمة القراء (حذف)</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-user-graduate"></i> التلاميذ</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="access_management" id="perm_std_access"> <label for="perm_std_access">الدخول للواجهة</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_add" id="perm_std_add"> <label for="perm_std_add">إضافة تلميذ</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_edit" id="perm_std_edit"> <label for="perm_std_edit">تعديل بيانات</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_delete" id="perm_std_del"> <label for="perm_std_del">حذف تلاميذ</label></div>
                             <div><input type="checkbox" class="perm-check" value="student_print" id="perm_std_print"> <label for="perm_std_print">طباعة البطاقات</label></div>
                             <div><input type="checkbox" class="perm-check" value="import_data" id="perm_std_import"> <label for="perm_std_import">استيراد البيانات</label></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong><i class="fas fa-cog"></i> الإدارة</strong>
                        <div style="margin-right: 15px;">
                             <div><input type="checkbox" class="perm-check" value="manage_users" id="perm_adm_users"> <label for="perm_adm_users">إدارة المستخدمين</label></div>
                             <div><input type="checkbox" class="perm-check" value="manage_settings" id="perm_adm_settings"> <label for="perm_adm_settings">الإعدادات العامة</label></div>
                             <div><input type="checkbox" class="perm-check" value="access_archive" id="perm_archive"> <label for="perm_archive">الأرشيف</label></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="submit" class="btn btn-primary" style="flex:1;">حفظ</button>
                <button type="button" class="btn btn-danger" onclick="closeUserModal()" style="flex:1;">إلغاء</button>
            </div>
        </form>
    </div>
</div>

<!-- Logs Modal -->
<div id="logsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div class="card" style="width:600px; padding:20px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
             <h3 style="margin:0;">سجل نشاط المستخدمين</h3>
             <button class="btn btn-danger" onclick="clearLogs()"><i class="fas fa-trash"></i> محو السجل</button>
        </div>
        <table style="width:100%; border-collapse: collapse;">
             <thead>
                 <tr style="background:#f1f5f9; text-align:right;">
                     <th style="padding:8px;">المستخدم</th>
                     <th style="padding:8px;">النشاط</th>
                     <th style="padding:8px;">التوقيت</th>
                 </tr>
             </thead>
             <tbody id="logsTableBody">
                 <tr><td colspan="3">جاري التحميل...</td></tr>
             </tbody>
        </table>
        <div style="text-align:center; margin-top:20px;">
             <button class="btn btn-secondary" onclick="document.getElementById('logsModal').style.display='none'">إغلاق</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/xlsx.full.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    loadUsers();
    check2FA();
});

async function loadSettings() {
    try {
        const response = await fetch('/canteen/settings/data/');
        const data = await response.json();

        if (data.name) document.getElementById('schoolName').value = data.name;
        if (data.academic_year) document.getElementById('academicYear').value = data.academic_year;
        if (data.director_name) document.getElementById('directorName').value = data.director_name;
        if (data.loan_limit) document.getElementById('loanLimit').value = data.loan_limit;
        if (data.admin_email) document.getElementById('adminEmail').value = data.admin_email;

        // Canteen
        if (data.canteen_open_time) document.getElementById('canteenOpen').value = data.canteen_open_time.substring(0,5);
        if (data.canteen_close_time) document.getElementById('canteenClose').value = data.canteen_close_time.substring(0,5);
        if (data.canteen_days) {
            const days = data.canteen_days.split(',');
            document.querySelectorAll('.day-check').forEach(chk => {
                chk.checked = days.includes(chk.value);
            });
        }
    } catch (error) {
        console.error("Error loading settings", error);
    }
}

async function saveSchoolSettings(e) {
    e.preventDefault();
    const data = {
        name: document.getElementById('schoolName').value,
        academic_year: document.getElementById('academicYear').value,
        director_name: document.getElementById('directorName').value,
        admin_email: document.getElementById('adminEmail').value
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المؤسسة بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

async function saveCanteenSettings(e) {
    e.preventDefault();
    const days = [];
    document.querySelectorAll('.day-check:checked').forEach(c => days.push(c.value));

    const data = {
        canteen_open_time: document.getElementById('canteenOpen').value,
        canteen_close_time: document.getElementById('canteenClose').value,
        canteen_days: days.join(',')
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المطعم بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

async function saveLibrarySettings(e) {
    e.preventDefault();
    const data = {
        loan_limit: document.getElementById('loanLimit').value
    };

    try {
        const response = await fetch('/canteen/settings/data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("تم حفظ إعدادات المكتبة بنجاح");
        } else {
            const errorText = await response.text();
            console.error("Save Error:", errorText);
            alert("حدث خطأ أثناء الحفظ: " + errorText);
        }
    } catch (error) {
        console.error(error);
        alert("خطأ في الاتصال: " + error);
    }
}

function handleFileSelect(input) {
    if (!input.files || !input.files[0]) return;
    if (!confirm("هل تريد استيراد البيانات من الملف المحدد؟ (سيتم المعالجة محلياً)")) return;

    const file = input.files[0];
    const reader = new FileReader();
    const updateExisting = document.getElementById('updateExisting').checked;

    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('progressText').textContent = "جاري قراءة الملف...";

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});

            // Assume first sheet
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];

            // Convert to JSON (Array of Arrays)
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false, dateNF:'yyyy-mm-dd'});

            if (!jsonData || jsonData.length < 5) {
                alert("الملف يبدو فارغاً أو غير صالح");
                resetImportUI();
                return;
            }

            processRows(jsonData, updateExisting);

        } catch (err) {
            console.error(err);
            alert("فشل قراءة الملف: تأكد أنه ملف Excel أو HTML صالح.");
            resetImportUI();
        }
    };
    reader.readAsArrayBuffer(file);
}

async function processRows(rows, updateExisting) {
    let students = [];

    // Skip headers - find first row with numeric ID in column 0
    for(let row of rows) {
        if (row && row.length > 10) {
            // Check if col 0 is numeric ID
            let id = String(row[0]).trim();
            if (/^\d+$/.test(id)) {
                // Map columns (adjust indices based on your known structure)
                // Assuming standard layout from previous code:
                // 0: ID, 1: Last, 2: First, 3: Gender, 4: DOB ...

                let dob = row[4];
                // Clean DOB if needed (SheetJS usually handles dates if cellDates:true, returning Date obj or formatted string)

                students.push({
                    student_id_number: id,
                    last_name: row[1],
                    first_name: row[2],
                    gender: row[3],
                    date_of_birth: dob,
                    place_of_birth: row[9],
                    academic_year: row[10],
                    class_name: (row[10] + " " + row[11]).trim(), // Level + ClassNum
                    attendance_system: row[12],
                    enrollment_number: row[13],
                    enrollment_date: row[14]
                });
            }
        }
    }

    if (students.length === 0) {
        alert("لم يتم العثور على بيانات تلاميذ صالحة في الملف.");
        resetImportUI();
        return;
    }

    // Send in batches
    const BATCH_SIZE = 100;
    const total = students.length;
    let successCount = 0;

    for (let i = 0; i < total; i += BATCH_SIZE) {
        const batch = students.slice(i, i + BATCH_SIZE);
        const progress = Math.round((i / total) * 100);
        document.getElementById('progressText').textContent = `جاري رفع ${i} من ${total} (${progress}%)`;

        try {
            const response = await fetch('/canteen/api/import_json/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    students: batch,
                    update_existing: updateExisting
                })
            });

            if (response.ok) {
                const res = await response.json();
                successCount += res.created + res.updated;
            } else {
                console.error("Batch failed", await response.text());
            }
        } catch (e) {
            console.error("Network error on batch", i, e);
        }
    }

    document.getElementById('progressText').textContent = "100% - اكتمل!";
    alert(`تمت العملية! تمت معالجة ${successCount} تلميذ.`);
    resetImportUI();
}

function resetImportUI() {
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('importFile').value = '';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// User Management Logic
async function loadUsers() {
    if (sessionStorage.getItem('user_role') !== 'director') return;
    document.getElementById('userManagementSection').style.display = 'block';
    document.getElementById('systemMsgSection').style.display = 'block';

    try {
        const response = await fetch('/canteen/api/users/');
        if (!response.ok) return;

        const users = await response.json();
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        users.forEach(u => {
            const tr = document.createElement('tr');
            let deviceBtn = '';
            if (u.device_status === 'مفعل') {
                deviceBtn = `<button class="btn btn-danger" onclick="resetDevice(${u.id})" style="padding:5px 10px;" title="تعطيل حماية الجهاز"><i class="fas fa-mobile-alt"></i> تعطيل</button>`;
            } else if (u.device_status === 'بانتظار التفعيل') {
                deviceBtn = `<span style="color:orange; font-size:0.8em">بانتظار الدخول...</span> <button class="btn btn-warning" onclick="resetDevice(${u.id})" style="padding:2px 5px;"><i class="fas fa-times"></i></button>`;
            } else {
                deviceBtn = `<button class="btn btn-success" onclick="activateDevice(${u.id})" style="padding:5px 10px;" title="تفعيل حماية الجهاز"><i class="fas fa-mobile-alt"></i> تفعيل</button>`;
            }

            tr.innerHTML = `
                <td class="western-nums" style="direction:ltr; text-align:left;">${u.username}</td>
                <td>${u.role_display}</td>
                <td>
                    ${u.is_locked ? '<span style="color:red; font-weight:bold;">مقفل</span>' : '<span style="color:green;">نشط</span>'}
                </td>
                <td>${deviceBtn}</td>
                <td class="western-nums">${u.failed_attempts}</td>
                <td>
                    <button class="btn btn-info" onclick='editUser(${JSON.stringify(u).replace(/'/g, "&#39;")})' style="padding:5px 10px;"><i class="fas fa-edit"></i></button>
                    ${u.is_locked ? `<button class="btn btn-success" onclick="unlockUser(${u.id})" style="padding:5px 10px;" title="فك القفل"><i class="fas fa-lock-open"></i></button>` : ''}
                    <button class="btn btn-warning" onclick="resetSession(${u.id})" style="padding:5px 10px;" title="إعادة ضبط الجلسة"><i class="fas fa-sync-alt"></i></button>
                    ${u.role !== 'director' ? `<button class="btn btn-danger" onclick="deleteUser(${u.id})" style="padding:5px 10px;" title="حذف"><i class="fas fa-trash"></i></button>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error(e);
    }
}

async function activateDevice(id) {
    if(!confirm("هل أنت متأكد من تفعيل حماية الجهاز لهذا المستخدم؟ سيتم ربط أول جهاز يقوم بتسجيل الدخول.")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/activate_device/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (response.ok) {
            alert("تم التفعيل. سيتم الربط عند الدخول القادم.");
            loadUsers();
        }
    } catch(e) { alert("خطأ"); }
}

async function resetDevice(id) {
    if(!confirm("هل أنت متأكد من تعطيل/إعادة ضبط حماية الجهاز؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/reset_device/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (response.ok) {
            alert("تم تعطيل الحماية.");
            loadUsers();
        }
    } catch(e) { alert("خطأ"); }
}


async function postSystemMessage(e) {
    e.preventDefault();
    const msg = document.getElementById('sysMsgText').value;
    try {
        const res = await fetch('/canteen/api/system_messages/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: msg, active: true })
        });
        if(res.ok) {
            alert("تم نشر الرسالة");
            document.getElementById('sysMsgText').value = '';
        }
    } catch(e) { alert("خطأ"); }
}

function openAddUserModal() {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'إضافة مستخدم';
    document.getElementById('userForm').reset();
    document.getElementById('editUserId').value = '';
    document.getElementById('pwdHint').style.display = 'none';
    document.getElementById('uPassword').required = true;
    document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
}

function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

function editUser(user) {
    document.getElementById('userModal').style.display = 'flex';
    document.getElementById('userModalTitle').textContent = 'تعديل مستخدم';
    document.getElementById('editUserId').value = user.id;
    document.getElementById('uUsername').value = user.username;
    document.getElementById('uRole').value = user.role;
    document.getElementById('uPassword').value = '';
    document.getElementById('uPassword').required = false;
    document.getElementById('pwdHint').style.display = 'block';

    // Populate permissions
    document.querySelectorAll('.perm-check').forEach(c => c.checked = false);
    if (user.permissions && Array.isArray(user.permissions)) {
        user.permissions.forEach(p => {
             const chk = document.querySelector(`.perm-check[value="${p}"]`);
             if(chk) chk.checked = true;
        });
    }
}

document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editUserId').value;
    const username = document.getElementById('uUsername').value;
    const password = document.getElementById('uPassword').value;
    const role = document.getElementById('uRole').value;

    // Collect permissions
    const permissions = [];
    document.querySelectorAll('.perm-check:checked').forEach(c => permissions.push(c.value));

    const url = id ? `/canteen/api/users/${id}/update_creds/` : '/canteen/api/users/';

    const body = { username, role, permissions };
    if (password) body.password = password;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(body)
        });

        if (response.ok) {
            alert(id ? "تم التعديل" : "تمت الإضافة");
            closeUserModal();
            loadUsers();
        } else {
            const err = await response.json();
            alert("خطأ: " + (err.error || JSON.stringify(err)));
        }
    } catch (e) {
        alert("خطأ في الاتصال");
    }
});

async function deleteUser(id) {
    if(!confirm("هل أنت متأكد من حذف هذا المستخدم نهائياً؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (response.ok) {
            alert("تم الحذف بنجاح");
            loadUsers();
        } else {
             const err = await response.json();
             alert("خطأ: " + (err.error || "تعذر الحذف"));
        }
    } catch(e) { alert("خطأ في الاتصال"); }
}

async function unlockUser(id) {
    if(!confirm("هل أنت متأكد من فك قفل هذا الحساب؟")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/unlock_account/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (response.ok) {
            alert("تم فك القفل");
            loadUsers();
        }
    } catch(e) { alert("خطأ"); }
}

async function resetSession(id) {
    if(!confirm("هل أنت متأكد من إعادة ضبط جلسة هذا المستخدم؟ سيتم تسجيل خروجه من جميع الأجهزة.")) return;
    try {
        const response = await fetch(`/canteen/api/users/${id}/reset_session/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (response.ok) {
            alert("تم إعادة ضبط الجلسة");
        }
    } catch(e) { alert("خطأ"); }
}

async function openLogsModal() {
    document.getElementById('logsModal').style.display = 'flex';
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '<tr><td colspan="3">جاري التحميل...</td></tr>';

    try {
        const res = await fetch('/canteen/api/users/logs/');
        const data = await res.json();
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">السجل فارغ</td></tr>';
            return;
        }

        data.forEach(log => {
            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px; direction:ltr; text-align:left;">${log.username}</td>
                    <td style="padding:8px;">
                        ${log.action === 'login' ? '<span style="color:green">دخول</span>' : '<span style="color:red">خروج</span>'}
                    </td>
                    <td style="padding:8px; direction:ltr;">${new Date(log.timestamp).toLocaleString()}</td>
                </tr>
            `;
        });
    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="3" style="color:red;">خطأ في التحميل</td></tr>';
    }
}

async function clearLogs() {
    if(!confirm('هل أنت متأكد من محو جميع السجلات؟')) return;
    try {
        const res = await fetch('/canteen/api/users/clear_logs/', {
            method: 'POST',
             headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if(res.ok) {
            alert('تم محو السجلات');
            openLogsModal();
        }
    } catch(e) { alert('خطأ'); }
}

// 2FA Logic
async function check2FA() {
    if (sessionStorage.getItem('user_role') !== 'director') return;
    document.getElementById('2faSection').style.display = 'block';

    // We can't check status easily without API, let's assume if role is director we show the section.
    // Ideally we fetch current status. For now, simple "Setup" button.
    render2FAInitial();
}

function render2FAInitial() {
    const area = document.getElementById('2faStatusArea');
    area.innerHTML = `
        <button class="btn btn-info" onclick="setup2FA()"><i class="fas fa-qrcode"></i> إعداد / إعادة ضبط المصادقة</button>
        <button class="btn btn-danger" onclick="disable2FA()"><i class="fas fa-ban"></i> تعطيل المصادقة</button>
    `;
}

async function setup2FA() {
    try {
        const res = await fetch('/canteen/auth/2fa/setup/', {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();

        const area = document.getElementById('2faStatusArea');
        area.innerHTML = `
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; text-align:center;">
                <p>امسح الرمز التالي بتطبيق المصادقة:</p>
                <img src="${data.qr_code}" style="width:150px; height:150px; border:1px solid #ddd; padding:5px; background:white;">
                <p style="margin-top:10px; font-family:monospace; direction:ltr;">Secret: ${data.secret}</p>

                <div style="margin-top:15px; max-width:300px; margin-left:auto; margin-right:auto;">
                    <input type="text" id="verify2fa" class="form-input western-nums" placeholder="أدخل الرمز (6 أرقام)" style="text-align:center; font-size:1.2rem; letter-spacing:3px;" maxlength="6">
                    <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="confirm2FA()">تأكيد وتفعيل</button>
                    <button class="btn" style="width:100%; margin-top:5px; background:#ddd;" onclick="render2FAInitial()">إلغاء</button>
                </div>
            </div>
        `;
    } catch(e) { alert("Error setting up 2FA"); }
}

async function confirm2FA() {
    const code = document.getElementById('verify2fa').value;
    if(!code) return alert("أدخل الرمز");

    try {
        const res = await fetch('/canteen/auth/2fa/confirm/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ code: code })
        });

        if (res.ok) {
            alert("تم تفعيل المصادقة الثنائية بنجاح!");
            render2FAInitial();
        } else {
            alert("الرمز غير صحيح");
        }
    } catch(e) { alert("Error"); }
}

async function disable2FA() {
    if(!confirm("هل أنت متأكد من تعطيل المصادقة الثنائية؟ سيقلل هذا من أمان الحساب.")) return;
    try {
        const res = await fetch('/canteen/auth/2fa/disable/', {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken')}
        });
        if(res.ok) alert("تم التعطيل");
    } catch(e) { alert("Error"); }
}
</script>
{% endblock %}
