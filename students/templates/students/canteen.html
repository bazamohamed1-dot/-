{% extends 'base.html' %}

{% block title %}المطعم المدرسي{% endblock %}
{% block header_title %}تسيير النظام نصف الداخلي{% endblock %}

{% block extra_css %}
<style>
    .scanner-section { background: white; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
    .scanner-input {
        width: 100%; max-width: 500px; padding: 15px; font-size: 1.5rem;
        border: 3px solid var(--accent); border-radius: 10px; text-align: center; outline: none; transition: 0.3s;
    }
    .scanner-input:focus { box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); border-color: var(--primary); }

    .student-display { display: flex; gap: 30px; margin-top: 30px; align-items: flex-start; }
    .photo-box {
        width: 200px; height: 260px; background: #f8fafc; border: 2px solid #e2e8f0;
        border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;
    }
    .photo-box img { width: 100%; height: 100%; object-fit: cover; }

    .info-box { flex: 1; background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    .info-label { color: #64748b; font-size: 0.9rem; font-weight: 700; }
    .info-value { font-size: 1.2rem; font-weight: 600; color: #334155; }

    .stats-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; flex: 1; }
    .stats-num { font-size: 2.5rem; font-weight: 800; margin: 10px 0; }

    .present-list-container { margin-top: 30px; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .present-list-container h3 { margin-top: 0; color: var(--success); }
    /* Table style for list */
    .present-table { width: 100%; border-collapse: collapse; }
    .present-table th, .present-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right; }
    .present-table th { background-color: #f8fafc; font-weight: bold; color: #64748b; }
    .present-list-scroll { max-height: 200px; overflow-y: auto; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%; border-radius: 8px; text-align: center; }
    .close { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: black; }
</style>
{% endblock %}

{% block content %}
<div class="grid-2" style="grid-template-columns: 2fr 1fr; align-items: start;">

    <!-- Left: Scanner & Student Info -->
    <div>
        <div class="scanner-section">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: var(--primary); font-family: 'Cairo', sans-serif;">
                <i class="fas fa-calendar-alt"></i> وجبة الإطعام ليوم : <span id="currentDateDisplay" style="color: var(--secondary);"></span>
            </h3>
            <input type="text" id="barcodeInput" class="scanner-input" placeholder="امسح البطاقة هنا..." autofocus autocomplete="off">
            <small style="display:block; margin-top:5px; color:#dc2626; font-weight:bold;">
                <i class="fas fa-exclamation-triangle"></i> تنبيه: يرجى التأكد من أن لغة لوحة المفاتيح هي الإنجليزية
            </small>
            <div id="alertBox" style="margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: bold; display: none;"></div>
        </div>

        <div class="student-display">
            <div class="photo-box">
                <img id="studentImage" src="" style="display: none;">
                <i class="fas fa-user fa-5x" id="placeholderIcon" style="color:#cbd5e1"></i>
            </div>

            <div class="info-box">
                <h2 style="margin: 0; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                    <span id="displayName">---</span>
                </h2>
                <div class="info-grid">
                    <div><div class="info-label">تاريخ الازدياد</div><div class="info-value" id="dob">---</div></div>
                    <div><div class="info-label">المستوى</div><div class="info-value" id="level">---</div></div>
                    <div><div class="info-label">القسم</div><div class="info-value" id="className">---</div></div>
                    <div><div class="info-label">النظام</div><div class="info-value" id="system">---</div></div>
                </div>
            </div>
        </div>

        <!-- Present Students List -->
        <div class="present-list-container">
            <h3><i class="fas fa-list-check"></i> قائمة الحضور اليوم</h3>
            <div class="present-list-scroll">
                <table class="present-table">
                    <thead>
                        <tr>
                            <th>الاسم واللقب</th>
                            <th>القسم</th>
                            <th>تاريخ الازدياد</th>
                        </tr>
                    </thead>
                    <tbody id="presentList">
                        <!-- Items populated via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Right: Stats -->
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <div class="stats-card">
            <div style="color: var(--primary); font-size: 1.5rem;"><i class="fas fa-users"></i></div>
            <div class="stats-num" id="totalCount">0</div>
            <div>مجموع نصف الداخلي</div>
        </div>
        <div class="stats-card">
            <div style="color: var(--success); font-size: 1.5rem;"><i class="fas fa-check-circle"></i></div>
            <div class="stats-num" style="color: var(--success);" id="presentCount">0</div>
            <div>عدد الحضور لهذا اليوم</div>
        </div>
        <div class="stats-card">
            <div style="color: var(--danger); font-size: 1.5rem;"><i class="fas fa-times-circle"></i></div>
            <div class="stats-num" style="color: var(--danger);" id="absentCount">0</div>
            <div>عدد الغياب لهذا اليوم</div>
        </div>

        <button class="btn btn-secondary" onclick="openManualModal()" style="background: #64748b; color: white;"><i class="fas fa-keyboard"></i> إدخال يدوي</button>
        <button class="btn btn-primary" onclick="window.location.reload()"><i class="fas fa-sync"></i> تحديث الإحصائيات</button>
        <button class="btn btn-warning" id="exportBtn" onclick="exportExcel()"><i class="fas fa-file-excel"></i> حفظ في إكسل</button>
    </div>
</div>

<!-- Manual Entry Modal -->
<div id="manualModal" class="modal">
    <div class="modal-content" style="width: 60%;">
        <span class="close" onclick="closeManualModal()">&times;</span>
        <h3 style="color:var(--primary); margin-top:0;">إدخال يدوي (تلاميذ بدون بطاقة)</h3>

        <div style="text-align: right; margin-bottom: 15px; display: flex; gap: 10px;">
            <input type="text" id="manualSearch" class="form-input" placeholder="ابحث بالاسم أو الرقم..." onkeyup="filterManualList()" style="flex: 2;">
            <select id="manualLevelFilter" class="form-input" style="flex: 1;" onchange="filterManualList()">
                <option value="">كل المستويات</option>
            </select>
            <select id="manualClassFilter" class="form-input" style="flex: 1;" onchange="filterManualList()">
                <option value="">كل الأقسام</option>
            </select>
        </div>

        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background: #f8fafc;">
                    <tr>
                        <th style="padding: 10px; text-align: right;">الاسم واللقب</th>
                        <th style="padding: 10px; text-align: right;">القسم</th>
                        <th style="padding: 10px; text-align: center;">إجراء</th>
                    </tr>
                </thead>
                <tbody id="manualListBody">
                    <tr><td colspan="3" style="padding: 20px; text-align: center;">جاري التحميل...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const input = document.getElementById('barcodeInput');
    // Focus logic: only force focus if no modal is open
    let modalOpen = false;

    input.focus();

    // Check for non-English chars
    input.addEventListener('input', function(e) {
        const val = this.value;
        // Check for Arabic chars range
        if (/[\u0600-\u06FF]/.test(val)) {
             showAlert('تنبيه: يبدو أنك تستخدم اللغة العربية! يرجى التحويل للإنجليزية.', 'warning');
        }
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            handleScan(this.value);
            this.value = '';
        }
    });

    document.addEventListener('click', (e) => {
        if (!modalOpen && !e.target.closest('button') && !e.target.closest('.modal-content')) {
            input.focus();
        }
    });

    async function handleScan(barcode) {
        if(!barcode) return;

        try {
            const res = await fetch('/canteen/scan_card/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ barcode })
            });

            let data;
            try {
                data = await res.json();
            } catch (jsonError) {
                console.error("JSON Parse Error:", jsonError);
                showAlert('خطأ في استجابة الخادم (غير مقروءة)', 'danger');
                return;
            }

            if (res.ok) {
                showStudent(data.student);
                showAlert('تم التسجيل بنجاح', 'success');
                updateStats();
                updatePresentList();
            } else {
                if (data.student) showStudent(data.student);

                if (data.code === 'LATE_ATE') {
                    showAlert('التلميذ أخذ وجبته مسبقاً', 'warning');
                    setTimeout(() => {
                        showAlert('انتهى وقت الإطعام (المطعم مغلق)', 'danger');
                    }, 2500);
                }
                else if (data.code === 'LATE_NOT_ATE') {
                     showAlert('التلميذ لم يتناول الوجبة', 'warning');
                     setTimeout(() => {
                        showAlert('انتهى وقت الإطعام (المطعم مغلق)', 'danger');
                    }, 2500);
                }
                else if (data.code === 'ALREADY_ATE') showAlert('تنبيه: التلميذ أخذ وجبته مسبقاً!', 'warning');
                else if (data.code === 'NOT_HALF_BOARD') showAlert('تنبيه: التلميذ ليس نصف داخلي!', 'danger');
                else if (data.code === 'NOT_FOUND') showAlert('خطأ: التلميذ غير موجود!', 'danger');
                else {
                    // Check for DRF detail or generic error
                    const msg = data.error || data.detail || 'خطأ غير معروف';
                    showAlert('خطأ: ' + msg, 'danger');
                    console.error("Scan Error Payload:", data);
                }
            }
        } catch (e) {
            showAlert('خطأ في الاتصال بالسيرفر', 'danger');
            console.error(e);
        }
    }

    function showStudent(s) {
        document.getElementById('displayName').textContent = `${s.last_name} ${s.first_name}`;
        document.getElementById('dob').textContent = s.date_of_birth;
        document.getElementById('level').textContent = s.academic_year;
        document.getElementById('className').textContent = s.class_name;
        document.getElementById('system').textContent = s.attendance_system;

        const img = document.getElementById('studentImage');
        if (s.photo_path) {
            img.src = s.photo_path;
            img.style.display = 'block';
            document.getElementById('placeholderIcon').style.display = 'none';
        } else {
            img.style.display = 'none';
            document.getElementById('placeholderIcon').style.display = 'block';
        }
    }

    function showAlert(msg, type) {
        const box = document.getElementById('alertBox');
        box.textContent = msg;
        box.style.display = 'block';
        box.className = '';

        if (type === 'success') { box.style.background = '#d1fae5'; box.style.color = '#065f46'; }
        else if (type === 'warning') { box.style.background = '#fef3c7'; box.style.color = '#92400e'; }
        else { box.style.background = '#fee2e2'; box.style.color = '#991b1b'; }

        setTimeout(() => box.style.display = 'none', 3000);
    }

    async function updateStats() {
        const res = await fetch('/canteen/canteen_stats/');
        const data = await res.json();
        document.getElementById('totalCount').textContent = data.total_half_board;
        document.getElementById('presentCount').textContent = data.present_count;
        document.getElementById('absentCount').textContent = data.absent_count;
    }

    async function updatePresentList() {
        try {
            const res = await fetch('/canteen/attendance_lists/');
            const data = await res.json();
            const list = document.getElementById('presentList');
            list.innerHTML = '';

            // Assuming the API returns { present: [...], absent: [...] }
            if (data.present && data.present.length > 0) {
                // Reverse to show newest top
                [...data.present].reverse().forEach(s => {
                    const row = document.createElement('tr');
                    // Point 10: Add Date of Birth
                    // Point 16: Ensure Western numerals
                    row.innerHTML = `
                        <td><b>${s.last_name} ${s.first_name}</b></td>
                        <td>${s.class_name}</td>
                        <td class="western-nums" style="direction:ltr;">${s.date_of_birth}</td>
                    `;
                    list.appendChild(row);
                });
            } else {
                list.innerHTML = '<tr><td colspan="3" style="text-align:center; color:gray">لا يوجد حضور حتى الآن</td></tr>';
            }
        } catch(e) { console.error(e); }
    }

    async function exportExcel() {
        if(!confirm('حفظ ملف الإكسل؟')) return;
        try {
            const res = await fetch('/canteen/export_canteen/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (res.ok) {
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                     const data = await res.json();
                     alert(data.message);
                     return;
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Canteen_Attendance.xlsx";
                document.body.appendChild(a);
                a.click();
                a.remove();
            } else {
                alert("حدث خطأ أثناء تحميل الملف");
            }
        } catch (e) {
            console.error(e);
            alert("حدث خطأ أثناء تحميل الملف");
        }
    }

    // Modal Functions
    let allStudents = [];

    async function openManualModal() {
        modalOpen = true;
        document.getElementById('manualModal').style.display = 'block';
        document.getElementById('manualSearch').focus();

        if(allStudents.length === 0) {
            try {
                // Fetch all students. Re-using attendance lists absent API is not enough, we need ALL half-board.
                // Or simply re-use get_attendance_lists -> absent is a good starting point but we want to allow marking ANYONE.
                // Better to fetch all Half-Board students. We don't have a specific API for "All Half Board" yet but /api/attendance_lists/ has "absent" which are the ones we likely want to add.
                // Let's rely on /api/attendance_lists/ 'absent' list for now as they are the targets.
                const res = await fetch('/canteen/attendance_lists/');
                const data = await res.json();
                allStudents = data.absent || []; // Only show absent students as candidates
                populateManualFilters();
                filterManualList();
            } catch(e) {
                console.error(e);
                document.getElementById('manualListBody').innerHTML = '<tr><td colspan="3">خطأ في التحميل</td></tr>';
            }
        } else {
            // Refresh logic if needed, or just use cached
             const res = await fetch('/canteen/attendance_lists/');
             const data = await res.json();
             allStudents = data.absent || [];
             filterManualList();
        }
    }

    function populateManualFilters() {
        const levelSelect = document.getElementById('manualLevelFilter');
        const levels = [...new Set(allStudents.map(s => s.academic_year))].sort();
        levelSelect.innerHTML = '<option value="">كل المستويات</option>' + levels.map(l => `<option value="${l}">${l}</option>`).join('');

        const classSelect = document.getElementById('manualClassFilter');
        const classes = [...new Set(allStudents.map(s => s.class_name))].sort();
        classSelect.innerHTML = '<option value="">كل الأقسام</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function filterManualList() {
        const query = document.getElementById('manualSearch').value.toLowerCase();
        const lvl = document.getElementById('manualLevelFilter').value;
        const cls = document.getElementById('manualClassFilter').value;
        const tbody = document.getElementById('manualListBody');

        const filtered = allStudents.filter(s => {
            const matchName = s.first_name.toLowerCase().includes(query) || s.last_name.toLowerCase().includes(query) || s.student_id_number.includes(query);
            const matchLevel = lvl ? s.academic_year === lvl : true;
            const matchClass = cls ? s.class_name === cls : true;
            return matchName && matchLevel && matchClass;
        });

        if(filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">لا يوجد نتائج</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(s => `
            <tr>
                <td style="padding:10px; border-bottom:1px solid #f1f5f9;">${s.last_name} ${s.first_name}</td>
                <td style="padding:10px; border-bottom:1px solid #f1f5f9;">${s.class_name}</td>
                <td style="padding:10px; border-bottom:1px solid #f1f5f9; text-align:center;">
                    <button class="btn btn-success" style="padding:5px 10px; font-size:0.8rem;" onclick="submitManual(${s.id})">تسجيل</button>
                </td>
            </tr>
        `).join('');
    }

    function closeManualModal() {
        document.getElementById('manualModal').style.display = 'none';
        modalOpen = false;
        input.focus();
    }

    async function submitManual(id) {
        if(!id) return;

        try {
            const res = await fetch('/canteen/manual_attendance/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ student_id: id })
            });
            const data = await res.json();

            if (res.ok) {
                // Remove from local list to avoid double add
                allStudents = allStudents.filter(s => s.id !== id);
                filterManualList();
                updateStats();
                updatePresentList();
                showAlert("تم تسجيل " + data.student?.first_name + " يدوياً", 'success');
            } else {
                alert(data.error || "خطأ");
            }
        } catch (e) {
            console.error(e);
            alert("خطأ في الاتصال");
        }
    }

    // Set Current Date
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', numberingSystem: 'latn' };
    // Force Western Arabic Numerals
    document.getElementById('currentDateDisplay').textContent = today.toLocaleDateString('ar-DZ', options);

    // Initial load
    updateStats();
    updatePresentList();

    // Restrict Export Button
    const userRole = sessionStorage.getItem('user_role');
    if (userRole !== 'director') {
        const btn = document.getElementById('exportBtn');
        if(btn) btn.style.display = 'none';
    }
</script>
{% endblock %}
