<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ¶Ø§Ø¡ Ø§Ù„ÙˆÙ„ÙŠ - Baza Systems</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <h2>ÙØ¶Ø§Ø¡ Ø§Ù„ÙˆÙ„ÙŠ</h2>

        <!-- Login Form -->
        <div id="login-form" class="card">
            <div class="form-group">
                <label for="student-id">Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</label>
                <input type="text" id="student-id" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ">
            </div>
            <div class="form-group">
                <label for="student-dob">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                <input type="date" id="student-dob">
            </div>
            <button onclick="loginParent()" class="btn">Ø¯Ø®ÙˆÙ„</button>
            <div id="login-error" class="alert hidden">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
        </div>

        <!-- Student Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Student Header Info -->
            <div class="card" style="display: flex; align-items: center; gap: 20px; background-color: #f8fafc;">
                <div id="student-photo-container">
                    <!-- Photo injected via JS -->
                    <div style="width: 80px; height: 80px; background-color: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <span style="font-size: 30px; color: #666;">ğŸ‘¤</span>
                    </div>
                </div>
                <div>
                    <h3 id="student-name" style="margin: 0; color: #2c3e50;">Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ°</h3>
                    <p style="margin: 5px 0; color: #64748b;">Ø§Ù„Ù‚Ø³Ù…: <span id="student-class" style="font-weight: bold;"></span></p>
                    <p style="margin: 5px 0; color: #64748b; font-size: 0.9em;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: <span id="student-dob-display"></span></p>
                </div>
                <div style="margin-right: auto;">
                    <button onclick="logout()" class="btn btn-danger" style="font-size: 0.8em;">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>

            <div class="card">
                <h3><span style="color: #e74c3c;">â—</span> Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„ØªØ£Ø®Ø±</h3>
                <div id="attendance-list">
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>

            <div class="card">
                <h3><span style="color: #3498db;">â—</span> Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
                <div id="messages-list">
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        async function loginParent() {
            const studentId = document.getElementById('student-id').value;
            const dob = document.getElementById('student-dob').value;
            const errorDiv = document.getElementById('login-error');

            if (!studentId || !dob) {
                errorDiv.innerText = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                // Query Firestore for matching student
                const snapshot = await db.collection('students')
                    .where('student_id_number', '==', studentId)
                    .where('date_of_birth', '==', dob)
                    .get();

                if (snapshot.empty) {
                    errorDiv.innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                    errorDiv.classList.remove('hidden');
                } else {
                    const studentDoc = snapshot.docs[0];
                    const studentData = studentDoc.data();
                    showDashboard(studentDoc.id, studentData);
                }
            } catch (error) {
                console.error("Login error:", error);
                errorDiv.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function showDashboard(docId, data) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            document.getElementById('student-name').innerText = `${data.first_name} ${data.last_name}`;
            document.getElementById('student-class').innerText = data.class_name;
            document.getElementById('student-dob-display').innerText = data.date_of_birth;

            // Photo Logic (Assuming photo_path might be stored or we use placeholder)
            // Currently sync script doesn't push photo path, but if we updated it later:
            if (data.photo_url) {
                document.getElementById('student-photo-container').innerHTML = `
                    <img src="${data.photo_url}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #3498db;">
                `;
            }

            // Load Attendance
            const attendanceSnap = await db.collection('attendance')
                .where('student_id', '==', docId)
                .orderBy('date', 'desc')
                .limit(20)
                .get();

            const attendanceList = document.getElementById('attendance-list');
            attendanceList.innerHTML = '';
            if (attendanceSnap.empty) {
                attendanceList.innerHTML = '<p style="text-align:center; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØºÙŠØ§Ø¨.</p>';
            } else {
                attendanceSnap.forEach(doc => {
                    const r = doc.data();
                    const badgeClass = r.type === 'ABSENT' ? 'badge-absent' : 'badge-late';
                    const typeLabel = r.type === 'ABSENT' ? 'ØºÙŠØ§Ø¨' : 'ØªØ£Ø®Ø±';
                    attendanceList.innerHTML += `
                        <div class="record-item">
                            <span class="badge ${badgeClass}">${typeLabel}</span>
                            <strong>${r.date}</strong>
                            <p>${r.reason || ''}</p>
                        </div>
                    `;
                });
            }

            // Load Messages
            const messagesSnap = await db.collection('messages')
                .where('student_id', '==', docId)
                .orderBy('date', 'desc')
                .limit(20)
                .get();

            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            if (messagesSnap.empty) {
                messagesList.innerHTML = '<p style="text-align:center; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„.</p>';
            } else {
                messagesSnap.forEach(doc => {
                    const m = doc.data();
                    messagesList.innerHTML += `
                        <div class="record-item">
                            <span class="badge badge-note">${m.type}</span>
                            <strong>${m.date} - ${m.title}</strong>
                            <p>${m.content}</p>
                        </div>
                    `;
                });
            }
        }

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>
