<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسيير متوسطة بوشنافة عمر (سحابي)</title>
    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #1e40af; --accent: #3b82f6; --success: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --bg: #f1f5f9;
            --sidebar-width: 260px; --header-height: 70px;
        }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg); color: #334155; }

        /* Layout */
        .wrapper { display: flex; min-height: 100vh; transition: opacity 0.3s; opacity: 0; }
        .wrapper.loaded { opacity: 1; }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-card { width: 350px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }

        /* Sidebar (Same as Local) */
        .sidebar {
            width: var(--sidebar-width); background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            color: white; display: flex; flex-direction: column; position: fixed; right: 0; height: 100%; z-index: 1000;
        }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-links { list-style: none; padding: 20px 10px; margin: 0; flex: 1; }
        .nav-item { margin-bottom: 5px; display: none; } /* Hidden by default until perm check */
        .nav-link {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #94a3b8;
            text-decoration: none; border-radius: 8px; transition: 0.3s; font-weight: 600; cursor: pointer;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }

        /* Main */
        .main { flex: 1; margin-right: var(--sidebar-width); }
        .header {
            height: var(--header-height); background: white; border-bottom: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
        }
        .content { padding: 30px; }

        /* Utilities */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: right; }
        th { background: #f8fafc; }

        /* Views */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .nav-item.locked { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <img src="https://img.icons8.com/color/96/school.png" style="margin-bottom: 20px;">
            <h2 style="margin-bottom: 20px; color: #334155;">تسجيل الدخول</h2>

            <button onclick="loginGoogle()" class="btn" style="background: #db4437; color: white; width: 100%; margin-bottom: 20px;">
                <i class="fab fa-google"></i> دخول بحساب جوجل
            </button>

            <div style="margin: 15px 0; color: #94a3b8;">- أو -</div>

            <input type="text" id="uUser" placeholder="اسم المستخدم (للحساب المحلي)">
            <input type="password" id="uPass" placeholder="كلمة المرور">
            <button onclick="loginLocal()" class="btn btn-primary" style="width: 100%;">دخول</button>
            <div id="login-msg" style="color: red; margin-top: 10px; font-size: 0.9em;"></div>
        </div>
    </div>

    <!-- App Wrapper -->
    <div class="wrapper" id="app-wrapper">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-school"></i> بوابة الموظفين</div>
            <ul class="nav-links">
                <li class="nav-item" id="nav-dashboard">
                    <a onclick="showView('dashboard')" class="nav-link active"><i class="fas fa-home"></i> الرئيسية</a>
                </li>
                <li class="nav-item" id="nav-students">
                    <a onclick="showView('students')" class="nav-link"><i class="fas fa-user-graduate"></i> التلاميذ</a>
                </li>
                <li class="nav-item" id="nav-canteen">
                    <a onclick="showView('canteen')" class="nav-link"><i class="fas fa-utensils"></i> المطعم</a>
                </li>
                <li class="nav-item" id="nav-library">
                    <a onclick="showView('library')" class="nav-link"><i class="fas fa-book"></i> المكتبة</a>
                </li>
            </ul>
        </aside>

        <main class="main">
            <header class="header">
                <div style="font-weight: bold; font-size: 1.2rem;">بوابة الخدمات السحابية</div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <span id="user-display">المستخدم</span>
                    <button onclick="logout()" class="btn btn-danger" style="padding: 5px 15px; font-size: 0.8rem;">خروج</button>
                </div>
            </header>

            <div class="content">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view-section active">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="card" style="background: white; padding: 20px; border-radius: 10px; border-right: 4px solid var(--primary);">
                            <h3>مرحباً بك</h3>
                            <p>يمكنك استخدام القائمة الجانبية للوصول للخدمات المتاحة لك.</p>
                        </div>
                    </div>
                </div>

                <!-- Students View -->
                <div id="view-students" class="view-section">
                    <h2 style="margin-bottom: 20px;">قائمة التلاميذ</h2>
                    <input type="text" id="std-search" placeholder="بحث بالاسم أو الرقم..." onkeyup="renderStudents(this.value)">
                    <div style="overflow-x: auto;">
                        <table id="std-table">
                            <thead><tr><th>الرقم</th><th>اللقب</th><th>الاسم</th><th>القسم</th><th>إجراءات</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Canteen View (Simple Check-in) -->
                <div id="view-canteen" class="view-section">
                    <h2>تسجيل الدخول للمطعم</h2>
                    <p>قم بإدخال رقم التلميذ لتسجيل حضوره (يتم إرساله للموافقة).</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="canteen-id" placeholder="رقم التلميذ" style="max-width: 300px;">
                        <button onclick="submitCanteen()" class="btn btn-success">تسجيل</button>
                    </div>
                </div>

                <!-- Library View (Stub) -->
                <div id="view-library" class="view-section">
                    <h2>المكتبة</h2>
                    <p>خاصية المكتبة السحابية قيد التطوير.</p>
                </div>

            </div>
        </main>
    </div>

    <!-- Hidden File Input for Photo Upload -->
    <input type="file" id="photoInput" style="display: none;" accept="image/*">

    <script src="app.js"></script>
    <script>
        let currentUserProfile = null;
        let allStudents = [];
        let profileUnsubscribe = null;

        // Auth Listener
        auth.onAuthStateChanged(async user => {
            if (user) {
                let username = user.email.split('@')[0];

                // Google Auth Mapping
                if (!user.email.endsWith('@bazasystems.com')) {
                    const sanitized = user.email.replace(/@/g, '_at_').replace(/\./g, '_dot_');
                    const mapDoc = await db.collection('allowed_users').doc(sanitized).get();
                    if(mapDoc.exists) {
                        username = mapDoc.data().username;
                    } else {
                        alert("غير مصرح لك");
                        auth.signOut();
                        return;
                    }
                }

                // Real-time Profile Listener (Kick-out & Dynamic Routing)
                profileUnsubscribe = db.collection('users_profiles').doc(username)
                    .onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            // 1. Kick-out Check
                            if (data.is_active_cloud === false) {
                                alert("لقد تم إلغاء صلاحية دخولك من قبل المدير.");
                                logout();
                                return;
                            }

                            currentUserProfile = data;
                            setupUI();

                            // 2. Dynamic Routing Check
                            if (data.assigned_interface && data.assigned_interface !== 'all') {
                                showView(data.assigned_interface);
                                // Hide Sidebar for strict focus? Or just restrict links.
                                // Let's hide other links.
                            }

                            document.getElementById('login-screen').style.display = 'none';
                            document.getElementById('app-wrapper').classList.add('loaded');
                            document.getElementById('user-display').innerText = username;
                            loadData();
                        } else {
                            // Profile deleted?
                            alert("حسابك غير موجود في النظام السحابي.");
                            logout();
                        }
                    });

            } else {
                if(profileUnsubscribe) profileUnsubscribe();
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-wrapper').classList.remove('loaded');
            }
        });

        function loginLocal() {
            const u = document.getElementById('uUser').value;
            const p = document.getElementById('uPass').value;
            auth.signInWithEmailAndPassword(`${u}@bazasystems.com`, p).catch(e => {
                document.getElementById('login-msg').innerText = "خطأ في الدخول";
            });
        }

        function loginGoogle() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        }

        function logout() {
            if(profileUnsubscribe) profileUnsubscribe();
            auth.signOut();
        }

        function setupUI() {
            const p = currentUserProfile.permissions || [];
            const r = currentUserProfile.role;
            const assigned = currentUserProfile.assigned_interface || 'all';

            const isDir = r === 'director';

            // Reset Nav
            document.querySelectorAll('.nav-item').forEach(el => el.style.display = 'none');

            // Dashboard always visible unless specific interface assigned
            if (assigned === 'all') {
                document.getElementById('nav-dashboard').style.display = 'block';
                if(isDir || p.includes('access_management')) document.getElementById('nav-students').style.display = 'block';
                if(isDir || p.includes('access_canteen')) document.getElementById('nav-canteen').style.display = 'block';
                if(isDir || p.includes('access_library')) document.getElementById('nav-library').style.display = 'block';
            } else {
                // Show ONLY the assigned interface link
                if(document.getElementById(`nav-${assigned}`)) {
                    document.getElementById(`nav-${assigned}`).style.display = 'block';
                }
            }
        }

        function showView(name) {
            // Security check based on assigned_interface
            if (currentUserProfile && currentUserProfile.assigned_interface !== 'all' && currentUserProfile.assigned_interface !== name) {
                return; // Prevent switching
            }

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const view = document.getElementById(`view-${name}`);
            if(view) view.classList.add('active');

            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        }

        async function loadData() {
            if(allStudents.length > 0) return; // Already loaded
            const snap = await db.collection('students').get();
            allStudents = [];
            snap.forEach(d => allStudents.push({id: d.id, ...d.data()}));
            renderStudents('');
        }

        function renderStudents(q) {
            const tbody = document.querySelector('#std-table tbody');
            tbody.innerHTML = '';
            const filtered = allStudents.filter(s =>
                s.last_name.includes(q) || s.first_name.includes(q) || s.student_id_number.includes(q)
            ).slice(0, 50);

            filtered.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.student_id_number}</td>
                        <td>${s.last_name}</td>
                        <td>${s.first_name}</td>
                        <td>${s.class_name}</td>
                        <td style="display:flex; gap:5px; justify-content:flex-end;">
                            <button onclick="reportAbsence('${s.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size:0.8em;">غياب</button>
                            <button onclick="triggerPhotoUpload('${s.id}')" class="btn btn-primary" style="padding: 5px 10px; font-size:0.8em;"><i class="fas fa-camera"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // Photo Upload Logic
        let currentUploadStudentId = null;
        function triggerPhotoUpload(id) {
            currentUploadStudentId = id;
            document.getElementById('photoInput').click();
        }

        document.getElementById('photoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file || !currentUploadStudentId) return;

            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`students_photos/${currentUploadStudentId}_${Date.now()}.jpg`);

            try {
                const snapshot = await fileRef.put(file);
                const url = await snapshot.ref.getDownloadURL();

                // Create Pending Update for Local Pull
                await db.collection('pending_updates').add({
                    type: 'PHOTO_UPLOAD',
                    student_ref: currentUploadStudentId,
                    photo_url: url,
                    submitted_by: currentUserProfile.username,
                    submitted_at: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });
                alert("تم رفع الصورة بنجاح (بانتظار المزامنة)");
            } catch(e) {
                console.error(e);
                alert("فشل الرفع");
            }
        });

        async function reportAbsence(id) {
            if(!confirm("تسجيل غياب؟")) return;
            await db.collection('pending_updates').add({
                type: 'ATTENDANCE',
                student_ref: id,
                details: { status: 'ABSENT' },
                submitted_by: currentUserProfile.username,
                submitted_at: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending',
                date: new Date().toISOString().split('T')[0]
            });
            alert("تم الإرسال");
        }

        async function submitCanteen() {
            const id = document.getElementById('canteen-id').value;
            if(!id) return;
            // Find student ID ref
            const s = allStudents.find(x => x.student_id_number == id);
            if(!s) return alert("تلميذ غير موجود");

            await db.collection('pending_updates').add({
                type: 'CanteenAttendance',
                data: { student_id: id },
                submitted_by: currentUserProfile.username,
                timestamp: new Date().toISOString(),
                status: 'pending'
            });
            alert("تم تسجيل الحضور (بانتظار الموافقة)");
            document.getElementById('canteen-id').value = '';
        }
    </script>
</body>
</html>
