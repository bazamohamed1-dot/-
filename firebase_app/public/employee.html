<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فضاء الموظفين - Baza Systems</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <h2>فضاء الموظفين</h2>

        <!-- Login Form -->
        <div id="login-form" class="card">

            <button onclick="loginWithGoogle()" class="btn" style="background-color: #db4437; width: 100%; margin-bottom: 20px;">
                <span style="font-weight: bold;">G</span> تسجيل الدخول عبر جوجل
            </button>

            <div style="text-align: center; margin: 10px 0; color: #aaa;">- أو -</div>

            <div class="form-group">
                <label for="username">اسم المستخدم</label>
                <input type="text" id="username" placeholder="مثال: ahmed">
            </div>
            <div class="form-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password">
            </div>
            <button onclick="loginEmployee()" class="btn">دخول</button>
            <div id="login-error" class="alert hidden">خطأ في الدخول</div>
        </div>

        <!-- Employee Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="card" style="background-color: #e3f2fd;">
                <h3>مرحباً <span id="employee-username"></span></h3>
                <button onclick="logout()" class="btn btn-danger">خروج</button>
            </div>

            <!-- Student Search -->
            <div class="card">
                <h3>البحث عن تلميذ</h3>
                <div class="form-group">
                    <input type="text" id="search-query" placeholder="أدخل اسم التلميذ أو رقم التعريف">
                    <button onclick="searchStudent()" class="btn" style="margin-top: 10px;">بحث</button>
                </div>
                <div id="search-results"></div>
            </div>

            <!-- Action Form (Hidden initially) -->
            <div id="action-form" class="card hidden">
                <h3 id="selected-student-name"></h3>
                <input type="hidden" id="selected-student-id">

                <div class="form-group">
                    <label>نوع العملية</label>
                    <select id="action-type">
                        <option value="attendance">تسجيل غياب/تأخر</option>
                        <option value="note">إرسال ملاحظة</option>
                    </select>
                </div>

                <!-- Attendance Fields -->
                <div id="attendance-fields">
                    <div class="form-group">
                        <label>الحالة</label>
                        <select id="att-status">
                            <option value="ABSENT">غياب</option>
                            <option value="LATE">تأخر</option>
                        </select>
                    </div>
                    <div class="form-group">
                         <label>السبب</label>
                         <input type="text" id="att-reason" placeholder="سبب الغياب (اختياري)">
                    </div>
                </div>

                <!-- Note Fields -->
                <div id="note-fields" class="hidden">
                    <div class="form-group">
                        <label>العنوان</label>
                        <input type="text" id="note-title" placeholder="عنوان الملاحظة">
                    </div>
                    <div class="form-group">
                        <label>المحتوى</label>
                        <textarea id="note-content" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>التاريخ</label>
                    <input type="date" id="action-date">
                </div>

                <button onclick="submitAction()" class="btn success">إرسال للموافقة</button>
                <div id="submission-msg" class="alert hidden"></div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Set default date to today
        document.getElementById('action-date').valueAsDate = new Date();

        // Auth State Listener
        auth.onAuthStateChanged(async user => {
            if (user) {
                // If user logged in, check authorization
                let isAuthorized = false;
                let displayIdentifier = user.email;

                // 1. Check if it's a "fake" email (username login) -> Always allowed (backend handles it)
                if (user.email && user.email.endsWith('@bazasystems.com')) {
                    isAuthorized = true;
                    displayIdentifier = user.email.split('@')[0];
                }
                // 2. Check if it's a Google User -> Validate against 'allowed_users' collection
                else {
                    try {
                        const sanitizedEmail = user.email.replace(/@/g, '_at_').replace(/\./g, '_dot_');
                        const doc = await db.collection('allowed_users').doc(sanitizedEmail).get();

                        if (doc.exists) {
                            isAuthorized = true;
                            displayIdentifier = doc.data().username || user.displayName;
                        } else {
                            // Not allowed
                            alert("هذا البريد الإلكتروني غير مصرح له بالدخول. يرجى مراجعة المدير لإضافة بريدك.");
                            auth.signOut();
                            return;
                        }
                    } catch (e) {
                        console.error("Auth check error:", e);
                        alert("حدث خطأ أثناء التحقق من الصلاحيات.");
                        auth.signOut();
                        return;
                    }
                }

                if (isAuthorized) {
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('employee-username').innerText = displayIdentifier;
                }
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                const errDiv = document.getElementById('login-error');
                errDiv.innerText = "فشل الدخول بجوجل: " + error.message;
                errDiv.classList.remove('hidden');
            });
        }

        function loginEmployee() {
            const username = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;

            if (!username || !pass) {
                const errDiv = document.getElementById('login-error');
                errDiv.innerText = "يرجى إدخال اسم المستخدم وكلمة المرور";
                errDiv.classList.remove('hidden');
                return;
            }

            // Append fake domain for Firebase Auth
            const email = `${username}@bazasystems.com`;

            auth.signInWithEmailAndPassword(email, pass)
                .catch(error => {
                    const errDiv = document.getElementById('login-error');
                    console.error(error);
                    errDiv.innerText = "بيانات الدخول غير صحيحة";
                    errDiv.classList.remove('hidden');
                });
        }

        function logout() {
            auth.signOut();
        }

        async function searchStudent() {
            const query = document.getElementById('search-query').value;
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = 'جاري البحث...';

            try {
                // Try searching by ID first
                let snapshot = await db.collection('students')
                    .where('student_id_number', '==', query)
                    .limit(5)
                    .get();

                // If empty, try searching by first name (requires exact match usually)
                if (snapshot.empty) {
                     snapshot = await db.collection('students')
                        .where('first_name', '==', query)
                        .limit(5)
                        .get();
                }

                resultsDiv.innerHTML = '';
                if (snapshot.empty) {
                    resultsDiv.innerText = "لم يتم العثور على تلميذ.";
                } else {
                    snapshot.forEach(doc => {
                        const s = doc.data();
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.style.width = '100%';
                        btn.style.marginTop = '5px';
                        btn.style.textAlign = 'right';
                        btn.innerText = `اختيار: ${s.first_name} ${s.last_name} (${s.class_name})`;
                        btn.onclick = () => selectStudent(doc.id, s);
                        resultsDiv.appendChild(btn);
                    });
                }
            } catch (e) {
                resultsDiv.innerText = "حدث خطأ: " + e.message;
            }
        }

        function selectStudent(id, data) {
            document.getElementById('action-form').classList.remove('hidden');
            document.getElementById('selected-student-name').innerText = `تسجيل لـ: ${data.first_name} ${data.last_name}`;
            document.getElementById('selected-student-id').value = id;
            // Scroll to form
            document.getElementById('action-form').scrollIntoView({behavior: "smooth"});
        }

        // Toggle Fields based on Action Type
        document.getElementById('action-type').addEventListener('change', (e) => {
            if (e.target.value === 'attendance') {
                document.getElementById('attendance-fields').classList.remove('hidden');
                document.getElementById('note-fields').classList.add('hidden');
            } else {
                document.getElementById('attendance-fields').classList.add('hidden');
                document.getElementById('note-fields').classList.remove('hidden');
            }
        });

        async function submitAction() {
            const studentId = document.getElementById('selected-student-id').value;
            const actionType = document.getElementById('action-type').value; // 'attendance' or 'note'
            const date = document.getElementById('action-date').value;
            const user = auth.currentUser;

            if (!studentId || !date) {
                alert("يرجى اختيار تلميذ وتاريخ.");
                return;
            }

            const payload = {
                student_ref: studentId, // Reference to Firestore ID
                submitted_by: user.email, // Use email to track who submitted (Google or Local)
                submitted_at: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending',
                date: date
            };

            if (actionType === 'attendance') {
                payload.type = 'ATTENDANCE';
                payload.details = {
                    status: document.getElementById('att-status').value,
                    reason: document.getElementById('att-reason').value
                };
            } else {
                payload.type = 'COMMUNICATION';
                payload.details = {
                    title: document.getElementById('note-title').value,
                    content: document.getElementById('note-content').value,
                    comm_type: 'NOTE'
                };
            }

            try {
                await db.collection('pending_updates').add(payload);
                const msg = document.getElementById('submission-msg');
                msg.innerText = "تم الإرسال بنجاح! بانتظار موافقة المدير.";
                msg.className = "alert success";
                msg.classList.remove('hidden');

                // Reset form
                setTimeout(() => {
                    document.getElementById('action-form').classList.add('hidden');
                    msg.classList.add('hidden');
                    document.getElementById('search-query').value = '';
                    document.getElementById('search-results').innerHTML = '';
                }, 3000);

            } catch (e) {
                console.error(e);
                alert("فشل الإرسال: " + e.message);
            }
        }
    </script>
</body>
</html>
